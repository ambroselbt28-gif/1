import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import'https://testingcf.jsdelivr.net/npm/jquery-ui/+esm';import{getPresetNames as t}from'https://testingcf.jsdelivr.net/npm/@types/function/preset/+esm';var n={};n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const o=$;var a=n.n(o);const l=_;var r=n.n(l);const c=Vue;function s(e){return!!(0,c.getCurrentScope)()&&((0,c.onScopeDispose)(e),!0)}const i=new WeakMap,d=(...e)=>{var t;const n=e[0],o=null==(t=(0,c.getCurrentInstance)())?void 0:t.proxy;if(null==o&&!(0,c.hasInjectionContext)())throw new Error('injectLocal must be called in setup');return o&&i.has(o)&&n in i.get(o)?i.get(o)[n]:(0,c.inject)(...e)};const m='undefined'!=typeof window&&'undefined'!=typeof document,u=('undefined'!=typeof WorkerGlobalScope&&(globalThis,WorkerGlobalScope),Object.prototype.toString),p=e=>'[object Object]'===u.call(e);function f(e){return e.endsWith('rem')?16*Number.parseFloat(e):Number.parseFloat(e)}function v(e){return Array.isArray(e)?e:[e]}function h(e){const t=Object.create(null);return n=>t[n]||(t[n]=e(n))}const b=/\B([A-Z])/g,g=(h(e=>e.replace(b,'-$1').toLowerCase()),/-(\w)/g);h(e=>e.replace(g,(_,e)=>e?e.toUpperCase():''));function x(e){return e||(0,c.getCurrentInstance)()}const y=m?window:void 0;m&&window.document,m&&window.navigator,m&&window.location;function N(e){var t;const n=(0,c.toValue)(e);return null!=(t=null==n?void 0:n.$el)?t:n}function E(...e){const t=[],n=()=>{t.forEach(e=>e()),t.length=0},o=(0,c.computed)(()=>{const t=v((0,c.toValue)(e[0])).filter(e=>null!=e);return t.every(e=>'string'!=typeof e)?t:void 0}),a=(l=()=>{var t,n;return[null!=(n=null==(t=o.value)?void 0:t.map(e=>N(e)))?n:[y].filter(e=>null!=e),v((0,c.toValue)(o.value?e[1]:e[0])),v((0,c.unref)(o.value?e[2]:e[1])),(0,c.toValue)(o.value?e[3]:e[2])]},r=([e,o,a,l])=>{if(n(),!(null==e?void 0:e.length)||!(null==o?void 0:o.length)||!(null==a?void 0:a.length))return;const r=p(l)?{...l}:l;t.push(...e.flatMap(e=>o.flatMap(t=>a.map(n=>((e,t,n,o)=>(e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)))(e,t,n,r)))))},i={flush:'post'},(0,c.watch)(l,r,{...i,immediate:!0}));var l,r,i;return s(n),()=>{a(),n()}}function V(e){const t=function(){const e=(0,c.shallowRef)(!1),t=(0,c.getCurrentInstance)();return t&&(0,c.onMounted)(()=>{e.value=!0},t),e}();return(0,c.computed)(()=>(t.value,Boolean(e())))}const w=Symbol('vueuse-ssr-width');function k(){const e=(0,c.hasInjectionContext)()?d(w,null):null;return'number'==typeof e?e:void 0}function B(e,t={}){const{window:n=y,ssrWidth:o=k()}=t,a=V(()=>n&&'matchMedia'in n&&'function'==typeof n.matchMedia),l=(0,c.shallowRef)('number'==typeof o),r=(0,c.shallowRef)(),s=(0,c.shallowRef)(!1);return(0,c.watchEffect)(()=>{if(l.value){l.value=!a.value;const t=(0,c.toValue)(e).split(',');return void(s.value=t.some(e=>{const t=e.includes('not all'),n=e.match(/\(\s*min-width:\s*(-?\d+(?:\.\d*)?[a-z]+\s*)\)/),a=e.match(/\(\s*max-width:\s*(-?\d+(?:\.\d*)?[a-z]+\s*)\)/);let l=Boolean(n||a);return n&&l&&(l=o>=f(n[1])),a&&l&&(l=o<=f(a[1])),t?!l:l}))}a.value&&(r.value=n.matchMedia((0,c.toValue)(e)),s.value=r.value.matches)}),E(r,'change',e=>{s.value=e.matches},{passive:!0}),(0,c.computed)(()=>s.value)}function C(e,t={}){function n(t,n){let o=(0,c.toValue)(e[(0,c.toValue)(t)]);return null!=n&&(o=function(e,t){var n;if('number'==typeof e)return e+t;const o=(null==(n=e.match(/^-?\d+\.?\d*/))?void 0:n[0])||'',a=e.slice(o.length),l=Number.parseFloat(o)+t;return Number.isNaN(l)?e:l+a}(o,n)),'number'==typeof o&&(o=`${o}px`),o}const{window:o=y,strategy:a='min-width',ssrWidth:l=k()}=t,r='number'==typeof l,s=r?(0,c.shallowRef)(!1):{value:!0};function i(e,t){return!s.value&&r?'min'===e?l>=f(t):l<=f(t):!!o&&o.matchMedia(`(${e}-width: ${t})`).matches}r&&function(e,t=!0,n){x(n)?(0,c.onMounted)(e,n):t?e():(0,c.nextTick)(e)}(()=>s.value=!!o);const d=e=>B(()=>`(min-width: ${n(e)})`,t),m=e=>B(()=>`(max-width: ${n(e)})`,t),u=Object.keys(e).reduce((e,t)=>(Object.defineProperty(e,t,{get:()=>'min-width'===a?d(t):m(t),enumerable:!0,configurable:!0}),e),{});function p(){const t=Object.keys(e).map(e=>[e,u[e],f(n(e))]).sort((e,t)=>e[2]-t[2]);return(0,c.computed)(()=>t.filter(([,e])=>e.value).map(([e])=>e))}return Object.assign(u,{greaterOrEqual:d,smallerOrEqual:m,greater:e=>B(()=>`(min-width: ${n(e,.1)})`,t),smaller:e=>B(()=>`(max-width: ${n(e,-.1)})`,t),between:(e,o)=>B(()=>`(min-width: ${n(e)}) and (max-width: ${n(o,-.1)})`,t),isGreater:e=>i('min',n(e,.1)),isGreaterOrEqual:e=>i('min',n(e)),isSmaller:e=>i('max',n(e,-.1)),isSmallerOrEqual:e=>i('max',n(e)),isInBetween:(e,t)=>i('min',n(e))&&i('max',n(t,-.1)),current:p,active(){const e=p();return(0,c.computed)(()=>0===e.value.length?'':e.value.at('min-width'===a?-1:0))}})}'undefined'!=typeof globalThis?globalThis:'undefined'!=typeof window?window:'undefined'!=typeof globalThis?globalThis:'undefined'!=typeof self&&self;Number.POSITIVE_INFINITY;const M={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},S={class:'flex items-center justify-between border-b p-4 bg-gray-50'},j={class:'flex-1 overflow-y-auto p-6'},D={class:'text-center space-y-2'},P={class:'text-gray-600'},O={class:'font-semibold text-gray-900'},A={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},T=(0,c.defineComponent)({__name:'DeleteBranchModal',props:{branchName:{}},emits:['close','delete'],setup(e,{emit:t}){const n=t,o=C({mobile:640}).smaller('mobile');function a(){n('delete')}return(t,n)=>((0,c.openBlock)(),(0,c.createElementBlock)('div',M,[(0,c.createElementVNode)('div',{class:(0,c.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,c.unref)(o)}])},[(0,c.createCommentVNode)(' 标题栏 '),(0,c.createElementVNode)('div',S,[n[3]||(n[3]=(0,c.createElementVNode)('h2',{class:'text-lg font-semibold'},'删除分支',-1)),(0,c.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[2]||(n[2]=[(0,c.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,c.createCommentVNode)(' 内容区 '),(0,c.createElementVNode)('div',j,[(0,c.createCommentVNode)(' 警告图标 '),n[7]||(n[7]=(0,c.createElementVNode)('div',{class:'flex justify-center mb-4'},[(0,c.createElementVNode)('div',{class:'w-16 h-16 rounded-full bg-red-100 flex items-center justify-center'},[(0,c.createElementVNode)('i',{class:'fas fa-exclamation-triangle text-3xl text-red-500'})])],-1)),(0,c.createCommentVNode)(' 警告文字 '),(0,c.createElementVNode)('div',D,[n[6]||(n[6]=(0,c.createElementVNode)('h3',{class:'text-lg font-semibold text-gray-900'},'确定要删除此分支吗？',-1)),(0,c.createElementVNode)('p',P,[n[4]||(n[4]=(0,c.createTextVNode)(' 分支 ',-1)),(0,c.createElementVNode)('span',O,'"'+(0,c.toDisplayString)(e.branchName)+'"',1),n[5]||(n[5]=(0,c.createTextVNode)(' 将被永久删除，此操作无法撤销。 ',-1))])])]),(0,c.createCommentVNode)(' 底部按钮 '),(0,c.createElementVNode)('div',A,[(0,c.createElementVNode)('button',{onClick:n[1]||(n[1]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,c.createElementVNode)('button',{onClick:a,class:'px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 active:bg-red-700 transition-colors touch-manipulation min-h-[44px]'},' 删除 ')])],2)]))}}),I={class:'fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4'},L={class:'flex items-center justify-between border-b p-4 bg-gray-50'},F={class:'flex-1 overflow-y-auto p-4'},R={class:'mb-4'},W={class:'font-medium'},U={class:'space-y-2'},q={class:'flex-1 min-w-0 pr-3'},G={class:'text-sm font-medium truncate'},J={key:0,class:'text-xs text-gray-500 truncate mt-1'},H=['onUpdate:modelValue'],Y={key:0,class:'p-8 text-center text-gray-500 text-sm'},Z={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},K=(0,c.defineComponent)({__name:'EditPromptsModal',props:{presetName:{},prompts:{}},emits:['close','saveAsNewBranch'],setup(e,{emit:t}){const n=e,o=t,a=C({mobile:640}).smaller('mobile');function l(){const e={};n.prompts.forEach(t=>{t.id&&(e[t.id]=t.enabled)}),o('saveAsNewBranch',e)}return(t,n)=>((0,c.openBlock)(),(0,c.createElementBlock)('div',I,[(0,c.createElementVNode)('div',{class:(0,c.normalizeClass)(['w-full max-w-2xl bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,c.unref)(a)}])},[(0,c.createCommentVNode)(' 标题栏 '),(0,c.createElementVNode)('div',L,[n[3]||(n[3]=(0,c.createElementVNode)('h2',{class:'text-lg font-semibold'},'修改预设条目',-1)),(0,c.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[2]||(n[2]=[(0,c.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,c.createCommentVNode)(' 内容区 '),(0,c.createElementVNode)('div',F,[(0,c.createElementVNode)('div',R,[n[4]||(n[4]=(0,c.createElementVNode)('span',{class:'text-sm text-gray-600'},'当前预设：',-1)),(0,c.createElementVNode)('span',W,(0,c.toDisplayString)(e.presetName),1)]),(0,c.createElementVNode)('div',U,[((0,c.openBlock)(!0),(0,c.createElementBlock)(c.Fragment,null,(0,c.renderList)(e.prompts,e=>((0,c.openBlock)(),(0,c.createElementBlock)('div',{key:e.id,class:(0,c.normalizeClass)(['flex items-center justify-between p-3 border rounded-lg transition-colors',{'bg-blue-50 border-blue-300':e.enabled,'hover:bg-gray-50':!e.enabled}])},[(0,c.createElementVNode)('div',q,[(0,c.createElementVNode)('div',G,(0,c.toDisplayString)(e.name),1),e.content?((0,c.openBlock)(),(0,c.createElementBlock)('div',J,(0,c.toDisplayString)(e.content),1)):(0,c.createCommentVNode)('v-if',!0)]),(0,c.withDirectives)((0,c.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':t=>e.enabled=t,class:'w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500 touch-manipulation cursor-pointer'},null,8,H),[[c.vModelCheckbox,e.enabled]])],2))),128)),e.prompts.length?(0,c.createCommentVNode)('v-if',!0):((0,c.openBlock)(),(0,c.createElementBlock)('div',Y,' 暂无提示词条目 '))])]),(0,c.createCommentVNode)(' 底部按钮 '),(0,c.createElementVNode)('div',Z,[(0,c.createElementVNode)('button',{onClick:n[1]||(n[1]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,c.createElementVNode)('button',{onClick:l,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors touch-manipulation min-h-[44px]'},' 保存为新分支 ')])],2)]))}}),Q='preset_branches';function X(){return getVariables({type:'script',script_id:getScriptId()})[Q]||{}}function ee(e){replaceVariables({...getVariables({type:'script',script_id:getScriptId()}),[Q]:e},{type:'script',script_id:getScriptId()})}function te(e){return X()[e]||null}function ne(e){const t=te(e);return t&&t.branches?Object.entries(t.branches).map(([e,n])=>({name:e,description:n.description,createdAt:n.createdAt,updatedAt:n.updatedAt,isActive:e===t.activeBranch})):[]}function oe(e){const t=te(e);return t?.activeBranch||null}function ae(){try{const e=getPreset('in_use');return e&&e.prompts?e.prompts.map(e=>({id:e.id||'',name:e.name||'未命名提示词',enabled:e.enabled||!1,content:e.content||''})):[]}catch(e){return console.error('获取预设提示词失败:',e),[]}}const le={key:0,class:'fixed bottom-4 right-4 z-50'},re={class:'fixed inset-0 z-50 bg-white flex flex-col'},ce={class:'flex-1 p-4 space-y-4 overflow-y-auto'},se=['value'],ie={class:'flex gap-2'},de={key:0,value:''},me=['value'],ue={key:0,class:'border rounded-lg divide-y max-h-64 overflow-y-auto'},pe=['onClick'],fe={class:'flex items-center justify-between'},ve={class:'flex-1 min-w-0'},he={class:'text-sm font-medium truncate'},be={key:0,class:'text-xs text-gray-500 truncate mt-1'},ge={key:0,class:'fas fa-check text-blue-500 ml-2'},xe={class:'flex flex-col gap-2 pt-2'},ye={key:0,class:'flex gap-2'},Ne={id:'preset-branch-float',class:'fixed z-50 w-80 bg-white rounded-lg shadow-xl border bg-opacity-95 backdrop-blur-sm',style:{left:'50%',top:'50%',transform:'translate(-50%, -50%)'}},Ee={class:'flex items-center gap-2 p-3 border-b'},Ve=['value'],we={key:0,value:''},ke=['value'],Be={key:0,class:'flex gap-1'},Ce={class:'max-h-64 overflow-y-auto'},Me={key:0,class:'p-4 text-center text-gray-500 text-sm'},Se={key:1,class:'divide-y'},je=['onClick'],De={class:'flex items-center justify-between'},Pe={class:'flex-1 min-w-0'},_e={class:'text-sm font-medium truncate'},Oe={key:0,class:'text-xs text-gray-500 truncate mt-1'},Ae={key:0,class:'fas fa-check text-blue-500'},$e=(0,c.defineComponent)({__name:'FloatingWindow',emits:['edit','rename','delete'],setup(e,{expose:n,emit:o}){const l=o,r=C({mobile:640}).smaller('mobile'),s=(0,c.ref)(!0),i=(0,c.ref)(null),d=(0,c.ref)([]),m=(0,c.ref)(''),u=(0,c.ref)([]),p=(0,c.ref)('');async function f(){try{const e=getLoadedPresetName();e&&(m.value=e,await v(m.value),p.value=oe(m.value)||'')}catch(e){console.error('加载当前预设失败:',e)}}async function v(e){try{u.value=ne(e)}catch(e){console.error('加载分支列表失败:',e),u.value=[]}}async function h(){try{await v(m.value),p.value=oe(m.value)||''}catch(e){console.error('切换预设失败:',e),toastr.error('切换预设失败')}}async function b(){if(p.value)try{(function(e,t){const n=X(),o=n[e];if(!o||!o.branches[t])return!1;const a=o.branches[t];try{const e=getPreset('in_use');return e&&e.prompts?(e.prompts.forEach(e=>{e.id&&a.promptsEnabled.hasOwnProperty(e.id)&&(e.enabled=a.promptsEnabled[e.id])}),replacePreset('in_use',e),o.activeBranch=t,ee(n),!0):(console.error('无法获取当前预设'),!1)}catch(e){return console.error('切换分支失败:',e),!1}})(m.value,p.value)?(await v(m.value),toastr.success('切换分支成功')):toastr.error('切换分支失败')}catch(e){console.error('切换分支失败:',e),toastr.error('切换分支失败')}}async function g(e){p.value=e,await b()}function x(){s.value=!s.value}function y(){l('edit')}function N(){p.value&&l('rename',p.value)}function E(){p.value&&l('delete',p.value)}return(0,c.onMounted)(async()=>{await async function(){try{const e=await async function(){try{return t()||[]}catch(e){return console.error('获取预设列表失败:',e),[]}}();d.value=e}catch(e){console.error('加载预设列表失败:',e),toastr.error('加载预设列表失败')}}(),await f(),r.value||(await(0,c.nextTick)(),function(){if(!i.value)return;const e=a()('#preset-branch-float');e.draggable({handle:i.value,containment:'window',stop:(e,t)=>{localStorage.setItem('preset-branch-position',JSON.stringify({left:t.position.left,top:t.position.top}))}});const t=localStorage.getItem('preset-branch-position');if(t)try{const{left:n,top:o}=JSON.parse(t);e.css({left:n,top:o})}catch(e){console.error('恢复悬浮窗位置失败:',e)}}())}),n({refreshPreset:f,refreshBranches:async()=>{m.value&&await v(m.value)}}),(e,t)=>((0,c.openBlock)(),(0,c.createElementBlock)(c.Fragment,null,[(0,c.createCommentVNode)(' 移动端：底部浮动按钮 '),(0,c.unref)(r)?((0,c.openBlock)(),(0,c.createElementBlock)('div',le,[s.value?((0,c.openBlock)(),(0,c.createElementBlock)(c.Fragment,{key:1},[(0,c.createCommentVNode)(' 移动端全屏展开 '),(0,c.createElementVNode)('div',re,[(0,c.createElementVNode)('div',{class:'flex items-center justify-between border-b p-4 bg-white'},[t[6]||(t[6]=(0,c.createElementVNode)('h2',{class:'text-lg font-semibold'},'预设分支管理',-1)),(0,c.createElementVNode)('button',{onClick:x,class:'p-2 touch-manipulation'},[...t[5]||(t[5]=[(0,c.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,c.createElementVNode)('div',ce,[(0,c.createCommentVNode)(' 预设选择 '),(0,c.createElementVNode)('div',null,[t[7]||(t[7]=(0,c.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'选择预设',-1)),(0,c.withDirectives)((0,c.createElementVNode)('select',{'onUpdate:modelValue':t[0]||(t[0]=e=>m.value=e),onChange:h,class:'w-full min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation bg-white'},[((0,c.openBlock)(!0),(0,c.createElementBlock)(c.Fragment,null,(0,c.renderList)(d.value,e=>((0,c.openBlock)(),(0,c.createElementBlock)('option',{key:e,value:e},(0,c.toDisplayString)(e),9,se))),128))],544),[[c.vModelSelect,m.value]])]),(0,c.createCommentVNode)(' 分支选择 '),(0,c.createElementVNode)('div',null,[t[8]||(t[8]=(0,c.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'选择分支',-1)),(0,c.createElementVNode)('div',ie,[(0,c.withDirectives)((0,c.createElementVNode)('select',{'onUpdate:modelValue':t[1]||(t[1]=e=>p.value=e),onChange:b,class:'flex-1 min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation bg-white'},[u.value.length?(0,c.createCommentVNode)('v-if',!0):((0,c.openBlock)(),(0,c.createElementBlock)('option',de,'无分支')),((0,c.openBlock)(!0),(0,c.createElementBlock)(c.Fragment,null,(0,c.renderList)(u.value,e=>((0,c.openBlock)(),(0,c.createElementBlock)('option',{key:e.name,value:e.name},(0,c.toDisplayString)(e.name),9,me))),128))],544),[[c.vModelSelect,p.value]])])]),(0,c.createCommentVNode)(' 分支列表 '),u.value.length>0?((0,c.openBlock)(),(0,c.createElementBlock)('div',ue,[((0,c.openBlock)(!0),(0,c.createElementBlock)(c.Fragment,null,(0,c.renderList)(u.value,e=>((0,c.openBlock)(),(0,c.createElementBlock)('div',{key:e.name,onClick:t=>g(e.name),class:(0,c.normalizeClass)(['p-3 cursor-pointer touch-manipulation',e.isActive?'bg-blue-50':'hover:bg-gray-50'])},[(0,c.createElementVNode)('div',fe,[(0,c.createElementVNode)('div',ve,[(0,c.createElementVNode)('div',he,(0,c.toDisplayString)(e.name),1),e.description?((0,c.openBlock)(),(0,c.createElementBlock)('div',be,(0,c.toDisplayString)(e.description),1)):(0,c.createCommentVNode)('v-if',!0)]),e.isActive?((0,c.openBlock)(),(0,c.createElementBlock)('i',ge)):(0,c.createCommentVNode)('v-if',!0)])],10,pe))),128))])):(0,c.createCommentVNode)('v-if',!0),(0,c.createCommentVNode)(' 操作按钮 '),(0,c.createElementVNode)('div',xe,[(0,c.createElementVNode)('button',{onClick:y,class:'w-full min-h-[44px] rounded-lg bg-blue-500 px-4 py-3 text-white font-medium touch-manipulation active:bg-blue-600'},[...t[9]||(t[9]=[(0,c.createElementVNode)('i',{class:'fas fa-edit mr-2'},null,-1),(0,c.createTextVNode)('修改条目 ',-1)])]),p.value?((0,c.openBlock)(),(0,c.createElementBlock)('div',ye,[(0,c.createElementVNode)('button',{onClick:N,class:'flex-1 min-h-[44px] rounded-lg bg-gray-200 px-4 py-3 font-medium touch-manipulation active:bg-gray-300'},[...t[10]||(t[10]=[(0,c.createElementVNode)('i',{class:'fas fa-edit mr-2'},null,-1),(0,c.createTextVNode)('重命名 ',-1)])]),(0,c.createElementVNode)('button',{onClick:E,class:'flex-1 min-h-[44px] rounded-lg bg-red-500 px-4 py-3 text-white font-medium touch-manipulation active:bg-red-600'},[...t[11]||(t[11]=[(0,c.createElementVNode)('i',{class:'fas fa-trash mr-2'},null,-1),(0,c.createTextVNode)('删除 ',-1)])])])):(0,c.createCommentVNode)('v-if',!0)])])])],2112)):((0,c.openBlock)(),(0,c.createElementBlock)('button',{key:0,onClick:x,class:'h-14 w-14 rounded-full bg-blue-500 shadow-lg touch-manipulation active:scale-95 flex items-center justify-center'},[...t[4]||(t[4]=[(0,c.createElementVNode)('i',{class:'fas fa-code-branch text-2xl text-white'},null,-1)])]))])):((0,c.openBlock)(),(0,c.createElementBlock)(c.Fragment,{key:1},[(0,c.createCommentVNode)(' 桌面端：悬浮窗 '),(0,c.createElementVNode)('div',Ne,[(0,c.createCommentVNode)(' 折叠状态 '),s.value?((0,c.openBlock)(),(0,c.createElementBlock)(c.Fragment,{key:1},[(0,c.createCommentVNode)(' 展开状态 '),(0,c.createElementVNode)('div',null,[(0,c.createCommentVNode)(' 顶部栏 '),(0,c.createElementVNode)('div',{class:'flex items-center justify-between p-3 border-b cursor-move bg-gray-50 rounded-t-lg',ref_key:'dragHandle',ref:i},[t[14]||(t[14]=(0,c.createElementVNode)('span',{class:'text-sm font-medium'},'预设分支',-1)),(0,c.createElementVNode)('button',{onClick:x,class:'text-gray-400 hover:text-gray-600'},[...t[13]||(t[13]=[(0,c.createElementVNode)('i',{class:'fas fa-chevron-up'},null,-1)])])],512),(0,c.createCommentVNode)(' 工具栏 '),(0,c.createElementVNode)('div',Ee,[(0,c.createElementVNode)('button',{onClick:y,class:'px-3 py-1.5 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors'},' 修改 '),(0,c.withDirectives)((0,c.createElementVNode)('select',{'onUpdate:modelValue':t[2]||(t[2]=e=>m.value=e),onChange:h,class:'flex-1 text-sm border rounded px-2 py-1.5 bg-white cursor-pointer'},[((0,c.openBlock)(!0),(0,c.createElementBlock)(c.Fragment,null,(0,c.renderList)(d.value,e=>((0,c.openBlock)(),(0,c.createElementBlock)('option',{key:e,value:e},(0,c.toDisplayString)(e),9,Ve))),128))],544),[[c.vModelSelect,m.value]]),(0,c.withDirectives)((0,c.createElementVNode)('select',{'onUpdate:modelValue':t[3]||(t[3]=e=>p.value=e),onChange:b,class:'flex-1 text-sm border rounded px-2 py-1.5 bg-white cursor-pointer'},[u.value.length?(0,c.createCommentVNode)('v-if',!0):((0,c.openBlock)(),(0,c.createElementBlock)('option',we,'无分支')),((0,c.openBlock)(!0),(0,c.createElementBlock)(c.Fragment,null,(0,c.renderList)(u.value,e=>((0,c.openBlock)(),(0,c.createElementBlock)('option',{key:e.name,value:e.name},(0,c.toDisplayString)(e.name),9,ke))),128))],544),[[c.vModelSelect,p.value]]),p.value?((0,c.openBlock)(),(0,c.createElementBlock)('div',Be,[(0,c.createElementVNode)('button',{onClick:N,class:'p-1.5 text-gray-500 hover:text-gray-700 transition-colors',title:'重命名'},[...t[15]||(t[15]=[(0,c.createElementVNode)('i',{class:'fas fa-edit text-xs'},null,-1)])]),(0,c.createElementVNode)('button',{onClick:E,class:'p-1.5 text-red-500 hover:text-red-700 transition-colors',title:'删除'},[...t[16]||(t[16]=[(0,c.createElementVNode)('i',{class:'fas fa-trash text-xs'},null,-1)])])])):(0,c.createCommentVNode)('v-if',!0)]),(0,c.createCommentVNode)(' 分支列表 '),(0,c.createElementVNode)('div',Ce,[u.value.length?((0,c.openBlock)(),(0,c.createElementBlock)('div',Se,[((0,c.openBlock)(!0),(0,c.createElementBlock)(c.Fragment,null,(0,c.renderList)(u.value,e=>((0,c.openBlock)(),(0,c.createElementBlock)('div',{key:e.name,onClick:t=>g(e.name),class:(0,c.normalizeClass)(['p-3 cursor-pointer hover:bg-gray-50 transition-colors',e.isActive?'bg-blue-50 border-l-4 border-blue-500':''])},[(0,c.createElementVNode)('div',De,[(0,c.createElementVNode)('div',Pe,[(0,c.createElementVNode)('div',_e,(0,c.toDisplayString)(e.name),1),e.description?((0,c.openBlock)(),(0,c.createElementBlock)('div',Oe,(0,c.toDisplayString)(e.description),1)):(0,c.createCommentVNode)('v-if',!0)]),e.isActive?((0,c.openBlock)(),(0,c.createElementBlock)('i',Ae)):(0,c.createCommentVNode)('v-if',!0)])],10,je))),128))])):((0,c.openBlock)(),(0,c.createElementBlock)('div',Me,' 暂无分支 '))])])],2112)):((0,c.openBlock)(),(0,c.createElementBlock)('div',{key:0,class:'flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50',onClick:x},[...t[12]||(t[12]=[(0,c.createElementVNode)('span',{class:'text-sm font-medium'},'预设分支',-1),(0,c.createElementVNode)('i',{class:'fas fa-chevron-down text-gray-400'},null,-1)])]))])],2112))],2112))}}),Te={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},ze={class:'flex items-center justify-between border-b p-4 bg-gray-50'},Ie={class:'flex-1 overflow-y-auto p-4 space-y-4'},Le={class:'px-4 py-3 bg-gray-100 rounded-lg text-sm text-gray-600'},Fe=['placeholder'],Re={key:0,class:'text-red-500 text-sm mt-1'},We={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},Ue=['disabled'],qe=(0,c.defineComponent)({__name:'RenameBranchModal',props:{oldName:{},existingBranches:{}},emits:['close','rename'],setup(e,{emit:t}){const n=e,o=t,a=C({mobile:640}).smaller('mobile'),l=(0,c.ref)(n.oldName),r=(0,c.computed)(()=>l.value?l.value===n.oldName?'新名称与原名称相同':n.existingBranches.includes(l.value)?'分支名称已存在':'':'分支名称不能为空');function s(){r.value||o('rename',l.value)}return(t,n)=>((0,c.openBlock)(),(0,c.createElementBlock)('div',Te,[(0,c.createElementVNode)('div',{class:(0,c.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,c.unref)(a)}])},[(0,c.createCommentVNode)(' 标题栏 '),(0,c.createElementVNode)('div',ze,[n[4]||(n[4]=(0,c.createElementVNode)('h2',{class:'text-lg font-semibold'},'重命名分支',-1)),(0,c.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[3]||(n[3]=[(0,c.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,c.createCommentVNode)(' 内容区 '),(0,c.createElementVNode)('div',Ie,[(0,c.createCommentVNode)(' 当前分支名称 '),(0,c.createElementVNode)('div',null,[n[5]||(n[5]=(0,c.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'当前分支名称',-1)),(0,c.createElementVNode)('div',Le,(0,c.toDisplayString)(e.oldName),1)]),(0,c.createCommentVNode)(' 新分支名称 '),(0,c.createElementVNode)('div',null,[n[6]||(n[6]=(0,c.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},[(0,c.createTextVNode)(' 新分支名称 '),(0,c.createElementVNode)('span',{class:'text-red-500'},'*')],-1)),(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':n[1]||(n[1]=e=>l.value=e),type:'text',placeholder:e.oldName,class:(0,c.normalizeClass)(['w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation',{'border-red-500':r.value}])},null,10,Fe),[[c.vModelText,l.value]]),r.value?((0,c.openBlock)(),(0,c.createElementBlock)('p',Re,(0,c.toDisplayString)(r.value),1)):(0,c.createCommentVNode)('v-if',!0)])]),(0,c.createCommentVNode)(' 底部按钮 '),(0,c.createElementVNode)('div',We,[(0,c.createElementVNode)('button',{onClick:n[2]||(n[2]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,c.createElementVNode)('button',{onClick:s,disabled:!l.value||!!r.value,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors touch-manipulation min-h-[44px]'},' 重命名 ',8,Ue)])],2)]))}}),Ge={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},Je={class:'flex items-center justify-between border-b p-4 bg-gray-50'},He={class:'flex-1 overflow-y-auto p-4 space-y-4'},Ye={key:0,class:'text-red-500 text-sm mt-1'},Ze={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},Ke=['disabled'],Qe=(0,c.defineComponent)({__name:'SaveBranchModal',props:{existingBranches:{}},emits:['close','save'],setup(e,{emit:t}){const n=e,o=t,a=C({mobile:640}).smaller('mobile'),l=(0,c.ref)(''),r=(0,c.ref)(''),s=(0,c.computed)(()=>l.value?n.existingBranches.includes(l.value)?'分支名称已存在':'':'分支名称不能为空');function i(){s.value||o('save',l.value,r.value)}return(e,t)=>((0,c.openBlock)(),(0,c.createElementBlock)('div',Ge,[(0,c.createElementVNode)('div',{class:(0,c.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,c.unref)(a)}])},[(0,c.createCommentVNode)(' 标题栏 '),(0,c.createElementVNode)('div',Je,[t[5]||(t[5]=(0,c.createElementVNode)('h2',{class:'text-lg font-semibold'},'保存为新分支',-1)),(0,c.createElementVNode)('button',{onClick:t[0]||(t[0]=t=>e.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...t[4]||(t[4]=[(0,c.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,c.createCommentVNode)(' 内容区 '),(0,c.createElementVNode)('div',He,[(0,c.createCommentVNode)(' 分支名称 '),(0,c.createElementVNode)('div',null,[t[6]||(t[6]=(0,c.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},[(0,c.createTextVNode)(' 分支名称 '),(0,c.createElementVNode)('span',{class:'text-red-500'},'*')],-1)),(0,c.withDirectives)((0,c.createElementVNode)('input',{'onUpdate:modelValue':t[1]||(t[1]=e=>l.value=e),type:'text',placeholder:'输入分支名称',class:(0,c.normalizeClass)(['w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation',{'border-red-500':s.value}])},null,2),[[c.vModelText,l.value]]),s.value?((0,c.openBlock)(),(0,c.createElementBlock)('p',Ye,(0,c.toDisplayString)(s.value),1)):(0,c.createCommentVNode)('v-if',!0)]),(0,c.createCommentVNode)(' 分支描述 '),(0,c.createElementVNode)('div',null,[t[7]||(t[7]=(0,c.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'描述（可选）',-1)),(0,c.withDirectives)((0,c.createElementVNode)('textarea',{'onUpdate:modelValue':t[2]||(t[2]=e=>r.value=e),placeholder:'输入分支描述',rows:'3',class:'w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation resize-none'},null,512),[[c.vModelText,r.value]])])]),(0,c.createCommentVNode)(' 底部按钮 '),(0,c.createElementVNode)('div',Ze,[(0,c.createElementVNode)('button',{onClick:t[3]||(t[3]=t=>e.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,c.createElementVNode)('button',{onClick:i,disabled:!l.value||!!s.value,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors touch-manipulation min-h-[44px]'},' 保存 ',8,Ke)])],2)]))}});async function Xe(){if(console.info('[预设分支管理] 脚本初始化开始'),'undefined'==typeof getPreset||'undefined'==typeof replacePreset)return console.error('[预设分支管理] 预设接口不可用'),void toastr.error('预设分支管理：预设接口不可用');const t=(0,c.createApp)({components:{FloatingWindow:$e,EditPromptsModal:K,SaveBranchModal:Qe,RenameBranchModal:qe,DeleteBranchModal:T},setup(){const e=(0,c.ref)(!1),t=(0,c.ref)(!1),n=(0,c.ref)(!1),o=(0,c.ref)(!1),a=(0,c.ref)([]),l=(0,c.ref)(''),s=(0,c.ref)(''),i=(0,c.ref)(''),d=(0,c.ref)(''),m=(0,c.ref)(''),u=(0,c.ref)(''),p=(0,c.ref)(null);eventOn(tavern_events.PRESET_CHANGED,async()=>{console.info('[预设分支管理] 预设已变更，刷新界面'),p.value&&await p.value.refreshPreset()});const f=r().debounce(()=>{try{const e=getLoadedPresetName();if(e&&oe(e)){!function(e,t){const n=X(),o=n[e];if(!o||!o.activeBranch)return;const a=o.activeBranch;o.branches[a]&&(o.branches[a].promptsEnabled={...t},o.branches[a].updatedAt=Date.now(),ee(n))}(e,function(){const e=ae(),t={};return e.forEach(e=>{e.id&&(t[e.id]=e.enabled)}),t}())}}catch(e){console.error('[预设分支管理] 更新激活分支失败:',e)}},1e3);let v=null;return setInterval(()=>{try{const e=getPreset('in_use'),t=JSON.stringify(e.prompts?.map(e=>({id:e.id,enabled:e.enabled})));v&&v!==t&&(console.info('[预设分支管理] 检测到预设变更'),f()),v=t}catch(e){}},2e3),{showEditModal:e,showSaveModal:t,showRenameModal:n,showDeleteModal:o,editPrompts:a,editPresetName:l,saveBranchName:s,saveBranchDescription:i,renameOldName:d,renameNewName:m,deleteBranchName:u,floatingWindowRef:p,openEditModal:function(){try{l.value=getLoadedPresetName()||'未知预设',a.value=ae(),e.value=!0}catch(e){console.error('[预设分支管理] 打开编辑弹窗失败:',e),toastr.error('打开编辑弹窗失败')}},openSaveBranchModal:function(e){a.value.forEach(t=>{t.id&&e.hasOwnProperty(t.id)&&(t.enabled=e[t.id])});const n=getLoadedPresetName();if(n){ne(n).map(e=>e.name);t.value=!0}},saveNewBranch:function(e,n){try{const o={};a.value.forEach(e=>{e.id&&(o[e.id]=e.enabled)});const l=getLoadedPresetName();if(!l)return void toastr.error('无法获取当前预设名称');const r=function(e,t,n,o){const a=X();a[e]||(a[e]={activeBranch:null,branches:{}});const l=a[e];if(l.branches[t])return!1;const r=Date.now(),c={promptsEnabled:{...n},createdAt:r,updatedAt:r,description:o};return l.branches[t]=c,l.activeBranch=t,ee(a),!0}(l,e,o,n);r?(t.value=!1,s.value='',i.value='',p.value&&p.value.refreshBranches(),toastr.success(`分支 "${e}" 创建成功`)):toastr.error('分支创建失败，可能名称已存在')}catch(e){console.error('[预设分支管理] 保存分支失败:',e),toastr.error('保存分支失败')}},openRenameModal:function(e){d.value=e,m.value=e,n.value=!0},renameBranchAction:function(e){try{const t=getLoadedPresetName();if(!t)return void toastr.error('无法获取当前预设名称');(function(e,t,n){const o=X(),a=o[e];return!(!a||!a.branches[t]||a.branches[n]||(a.branches[n]={...a.branches[t],updatedAt:Date.now()},a.activeBranch===t&&(a.activeBranch=n),delete a.branches[t],ee(o),0))})(t,d.value,e)?(n.value=!1,d.value='',m.value='',p.value&&p.value.refreshBranches(),toastr.success('分支重命名成功')):toastr.error('分支重命名失败，可能名称已存在')}catch(e){console.error('[预设分支管理] 重命名分支失败:',e),toastr.error('重命名分支失败')}},openDeleteModal:function(e){u.value=e,o.value=!0},deleteBranchAction:function(){try{const e=getLoadedPresetName();if(!e)return void toastr.error('无法获取当前预设名称');(function(e,t){const n=X(),o=n[e];if(!o||!o.branches[t])return!1;if(o.activeBranch===t){const e=Object.keys(o.branches).filter(e=>e!==t);o.activeBranch=e.length>0?e[0]:null}return delete o.branches[t],0===Object.keys(o.branches).length&&delete n[e],ee(n),!0})(e,u.value)?(o.value=!1,u.value='',p.value&&p.value.refreshBranches(),toastr.success('分支删除成功')):toastr.error('分支删除失败')}catch(e){console.error('[预设分支管理] 删除分支失败:',e),toastr.error('删除分支失败')}},getExistingBranchNames:()=>{const e=getLoadedPresetName();return e?ne(e).map(e=>e.name):[]}}},template:'\n      <div>\n        <FloatingWindow ref="floatingWindowRef" @edit="openEditModal" @rename="openRenameModal" @delete="openDeleteModal" />\n        <EditPromptsModal v-if="showEditModal" :preset-name="editPresetName" :prompts="editPrompts" @close="showEditModal = false" @saveAsNewBranch="openSaveBranchModal" />\n        <SaveBranchModal v-if="showSaveModal" :existing-branches="getExistingBranchNames()" @close="showSaveModal = false" @save="saveNewBranch" />\n        <RenameBranchModal v-if="showRenameModal" :old-name="renameOldName" :existing-branches="getExistingBranchNames()" @close="showRenameModal = false" @rename="renameBranchAction" />\n        <DeleteBranchModal v-if="showDeleteModal" :branch-name="deleteBranchName" @close="showDeleteModal = false" @delete="deleteBranchAction" />\n      </div>\n    '}),n=e();t.use(n);const o=function(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}(),l=$('<div>').attr('script_id',getScriptId()).appendTo('body');t.mount(l[0]),console.info('[预设分支管理] 脚本初始化完成'),toastr.success('预设分支管理已加载'),a()(window).on('pagehide',()=>{t.unmount(),l.remove(),o(),console.info('[预设分支管理] 脚本已卸载')})}a()(()=>{errorCatched(Xe)()});
//# sourceMappingURL=index.js.map