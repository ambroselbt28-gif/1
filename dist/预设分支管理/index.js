import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import'https://testingcf.jsdelivr.net/npm/jquery-ui/+esm';var t={};t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},t.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const n=$;var o=t.n(n);const a=_;var l=t.n(a);const r=Vue;function c(e){return!!(0,r.getCurrentScope)()&&((0,r.onScopeDispose)(e),!0)}const s=new WeakMap,i=(...e)=>{var t;const n=e[0],o=null==(t=(0,r.getCurrentInstance)())?void 0:t.proxy;if(null==o&&!(0,r.hasInjectionContext)())throw new Error('injectLocal must be called in setup');return o&&s.has(o)&&n in s.get(o)?s.get(o)[n]:(0,r.inject)(...e)};const d='undefined'!=typeof window&&'undefined'!=typeof document,u=('undefined'!=typeof WorkerGlobalScope&&(globalThis,WorkerGlobalScope),Object.prototype.toString),m=e=>'[object Object]'===u.call(e);function p(e){return e.endsWith('rem')?16*Number.parseFloat(e):Number.parseFloat(e)}function f(e){return Array.isArray(e)?e:[e]}function v(e){const t=Object.create(null);return n=>t[n]||(t[n]=e(n))}const h=/\B([A-Z])/g,b=(v(e=>e.replace(h,'-$1').toLowerCase()),/-(\w)/g);v(e=>e.replace(b,(_,e)=>e?e.toUpperCase():''));function g(e){return e||(0,r.getCurrentInstance)()}const x=d?window:void 0;d&&window.document,d&&window.navigator,d&&window.location;function y(e){var t;const n=(0,r.toValue)(e);return null!=(t=null==n?void 0:n.$el)?t:n}function N(...e){const t=[],n=()=>{t.forEach(e=>e()),t.length=0},o=(0,r.computed)(()=>{const t=f((0,r.toValue)(e[0])).filter(e=>null!=e);return t.every(e=>'string'!=typeof e)?t:void 0}),a=(l=()=>{var t,n;return[null!=(n=null==(t=o.value)?void 0:t.map(e=>y(e)))?n:[x].filter(e=>null!=e),f((0,r.toValue)(o.value?e[1]:e[0])),f((0,r.unref)(o.value?e[2]:e[1])),(0,r.toValue)(o.value?e[3]:e[2])]},s=([e,o,a,l])=>{if(n(),!(null==e?void 0:e.length)||!(null==o?void 0:o.length)||!(null==a?void 0:a.length))return;const r=m(l)?{...l}:l;t.push(...e.flatMap(e=>o.flatMap(t=>a.map(n=>((e,t,n,o)=>(e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)))(e,t,n,r)))))},i={flush:'post'},(0,r.watch)(l,s,{...i,immediate:!0}));var l,s,i;return c(n),()=>{a(),n()}}function E(e){const t=function(){const e=(0,r.shallowRef)(!1),t=(0,r.getCurrentInstance)();return t&&(0,r.onMounted)(()=>{e.value=!0},t),e}();return(0,r.computed)(()=>(t.value,Boolean(e())))}const V=Symbol('vueuse-ssr-width');function w(){const e=(0,r.hasInjectionContext)()?i(V,null):null;return'number'==typeof e?e:void 0}function k(e,t={}){const{window:n=x,ssrWidth:o=w()}=t,a=E(()=>n&&'matchMedia'in n&&'function'==typeof n.matchMedia),l=(0,r.shallowRef)('number'==typeof o),c=(0,r.shallowRef)(),s=(0,r.shallowRef)(!1);return(0,r.watchEffect)(()=>{if(l.value){l.value=!a.value;const t=(0,r.toValue)(e).split(',');return void(s.value=t.some(e=>{const t=e.includes('not all'),n=e.match(/\(\s*min-width:\s*(-?\d+(?:\.\d*)?[a-z]+\s*)\)/),a=e.match(/\(\s*max-width:\s*(-?\d+(?:\.\d*)?[a-z]+\s*)\)/);let l=Boolean(n||a);return n&&l&&(l=o>=p(n[1])),a&&l&&(l=o<=p(a[1])),t?!l:l}))}a.value&&(c.value=n.matchMedia((0,r.toValue)(e)),s.value=c.value.matches)}),N(c,'change',e=>{s.value=e.matches},{passive:!0}),(0,r.computed)(()=>s.value)}function B(e,t={}){function n(t,n){let o=(0,r.toValue)(e[(0,r.toValue)(t)]);return null!=n&&(o=function(e,t){var n;if('number'==typeof e)return e+t;const o=(null==(n=e.match(/^-?\d+\.?\d*/))?void 0:n[0])||'',a=e.slice(o.length),l=Number.parseFloat(o)+t;return Number.isNaN(l)?e:l+a}(o,n)),'number'==typeof o&&(o=`${o}px`),o}const{window:o=x,strategy:a='min-width',ssrWidth:l=w()}=t,c='number'==typeof l,s=c?(0,r.shallowRef)(!1):{value:!0};function i(e,t){return!s.value&&c?'min'===e?l>=p(t):l<=p(t):!!o&&o.matchMedia(`(${e}-width: ${t})`).matches}c&&function(e,t=!0,n){g(n)?(0,r.onMounted)(e,n):t?e():(0,r.nextTick)(e)}(()=>s.value=!!o);const d=e=>k(()=>`(min-width: ${n(e)})`,t),u=e=>k(()=>`(max-width: ${n(e)})`,t),m=Object.keys(e).reduce((e,t)=>(Object.defineProperty(e,t,{get:()=>'min-width'===a?d(t):u(t),enumerable:!0,configurable:!0}),e),{});function f(){const t=Object.keys(e).map(e=>[e,m[e],p(n(e))]).sort((e,t)=>e[2]-t[2]);return(0,r.computed)(()=>t.filter(([,e])=>e.value).map(([e])=>e))}return Object.assign(m,{greaterOrEqual:d,smallerOrEqual:u,greater:e=>k(()=>`(min-width: ${n(e,.1)})`,t),smaller:e=>k(()=>`(max-width: ${n(e,-.1)})`,t),between:(e,o)=>k(()=>`(min-width: ${n(e)}) and (max-width: ${n(o,-.1)})`,t),isGreater:e=>i('min',n(e,.1)),isGreaterOrEqual:e=>i('min',n(e)),isSmaller:e=>i('max',n(e,-.1)),isSmallerOrEqual:e=>i('max',n(e)),isInBetween:(e,t)=>i('min',n(e))&&i('max',n(t,-.1)),current:f,active(){const e=f();return(0,r.computed)(()=>0===e.value.length?'':e.value.at('min-width'===a?-1:0))}})}'undefined'!=typeof globalThis?globalThis:'undefined'!=typeof window?window:'undefined'!=typeof globalThis?globalThis:'undefined'!=typeof self&&self;Number.POSITIVE_INFINITY;const C={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},M={class:'flex items-center justify-between border-b p-4 bg-gray-50'},S={class:'flex-1 overflow-y-auto p-6'},j={class:'text-center space-y-2'},D={class:'text-gray-600'},P={class:'font-semibold text-gray-900'},O={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},A=(0,r.defineComponent)({__name:'DeleteBranchModal',props:{branchName:{}},emits:['close','delete'],setup(e,{emit:t}){const n=t,o=B({mobile:640}).smaller('mobile');function a(){n('delete')}return(t,n)=>((0,r.openBlock)(),(0,r.createElementBlock)('div',C,[(0,r.createElementVNode)('div',{class:(0,r.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,r.unref)(o)}])},[(0,r.createCommentVNode)(' 标题栏 '),(0,r.createElementVNode)('div',M,[n[3]||(n[3]=(0,r.createElementVNode)('h2',{class:'text-lg font-semibold'},'删除分支',-1)),(0,r.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[2]||(n[2]=[(0,r.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,r.createCommentVNode)(' 内容区 '),(0,r.createElementVNode)('div',S,[(0,r.createCommentVNode)(' 警告图标 '),n[7]||(n[7]=(0,r.createElementVNode)('div',{class:'flex justify-center mb-4'},[(0,r.createElementVNode)('div',{class:'w-16 h-16 rounded-full bg-red-100 flex items-center justify-center'},[(0,r.createElementVNode)('i',{class:'fas fa-exclamation-triangle text-3xl text-red-500'})])],-1)),(0,r.createCommentVNode)(' 警告文字 '),(0,r.createElementVNode)('div',j,[n[6]||(n[6]=(0,r.createElementVNode)('h3',{class:'text-lg font-semibold text-gray-900'},'确定要删除此分支吗？',-1)),(0,r.createElementVNode)('p',D,[n[4]||(n[4]=(0,r.createTextVNode)(' 分支 ',-1)),(0,r.createElementVNode)('span',P,'"'+(0,r.toDisplayString)(e.branchName)+'"',1),n[5]||(n[5]=(0,r.createTextVNode)(' 将被永久删除，此操作无法撤销。 ',-1))])])]),(0,r.createCommentVNode)(' 底部按钮 '),(0,r.createElementVNode)('div',O,[(0,r.createElementVNode)('button',{onClick:n[1]||(n[1]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,r.createElementVNode)('button',{onClick:a,class:'px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 active:bg-red-700 transition-colors touch-manipulation min-h-[44px]'},' 删除 ')])],2)]))}}),T={class:'fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4'},I={class:'flex items-center justify-between border-b p-4 bg-gray-50'},L={class:'flex-1 overflow-y-auto p-4'},F={class:'mb-4'},R={class:'font-medium'},W={class:'space-y-2'},U={class:'flex-1 min-w-0 pr-3'},q={class:'text-sm font-medium truncate'},G={key:0,class:'text-xs text-gray-500 truncate mt-1'},J=['onUpdate:modelValue'],H={key:0,class:'p-8 text-center text-gray-500 text-sm'},Y={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},Z=(0,r.defineComponent)({__name:'EditPromptsModal',props:{presetName:{},prompts:{}},emits:['close','saveAsNewBranch'],setup(e,{emit:t}){const n=e,o=t,a=B({mobile:640}).smaller('mobile');function l(){const e={};n.prompts.forEach(t=>{t.id&&(e[t.id]=t.enabled)}),o('saveAsNewBranch',e)}return(t,n)=>((0,r.openBlock)(),(0,r.createElementBlock)('div',T,[(0,r.createElementVNode)('div',{class:(0,r.normalizeClass)(['w-full max-w-2xl bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,r.unref)(a)}])},[(0,r.createCommentVNode)(' 标题栏 '),(0,r.createElementVNode)('div',I,[n[3]||(n[3]=(0,r.createElementVNode)('h2',{class:'text-lg font-semibold'},'修改预设条目',-1)),(0,r.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[2]||(n[2]=[(0,r.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,r.createCommentVNode)(' 内容区 '),(0,r.createElementVNode)('div',L,[(0,r.createElementVNode)('div',F,[n[4]||(n[4]=(0,r.createElementVNode)('span',{class:'text-sm text-gray-600'},'当前预设：',-1)),(0,r.createElementVNode)('span',R,(0,r.toDisplayString)(e.presetName),1)]),(0,r.createElementVNode)('div',W,[((0,r.openBlock)(!0),(0,r.createElementBlock)(r.Fragment,null,(0,r.renderList)(e.prompts,e=>((0,r.openBlock)(),(0,r.createElementBlock)('div',{key:e.id,class:(0,r.normalizeClass)(['flex items-center justify-between p-3 border rounded-lg transition-colors',{'bg-blue-50 border-blue-300':e.enabled,'hover:bg-gray-50':!e.enabled}])},[(0,r.createElementVNode)('div',U,[(0,r.createElementVNode)('div',q,(0,r.toDisplayString)(e.name),1),e.content?((0,r.openBlock)(),(0,r.createElementBlock)('div',G,(0,r.toDisplayString)(e.content),1)):(0,r.createCommentVNode)('v-if',!0)]),(0,r.withDirectives)((0,r.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':t=>e.enabled=t,class:'w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500 touch-manipulation cursor-pointer'},null,8,J),[[r.vModelCheckbox,e.enabled]])],2))),128)),e.prompts.length?(0,r.createCommentVNode)('v-if',!0):((0,r.openBlock)(),(0,r.createElementBlock)('div',H,' 暂无提示词条目 '))])]),(0,r.createCommentVNode)(' 底部按钮 '),(0,r.createElementVNode)('div',Y,[(0,r.createElementVNode)('button',{onClick:n[1]||(n[1]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,r.createElementVNode)('button',{onClick:l,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors touch-manipulation min-h-[44px]'},' 保存为新分支 ')])],2)]))}}),K='preset_branches';function Q(){return getVariables({type:'script',script_id:getScriptId()})[K]||{}}function X(e){replaceVariables({...getVariables({type:'script',script_id:getScriptId()}),[K]:e},{type:'script',script_id:getScriptId()})}function ee(e){return Q()[e]||null}function te(e){const t=ee(e);return t&&t.branches?Object.entries(t.branches).map(([e,n])=>({name:e,description:n.description,createdAt:n.createdAt,updatedAt:n.updatedAt,isActive:e===t.activeBranch})):[]}function ne(e){const t=ee(e);return t?.activeBranch||null}function oe(){try{const e=getPreset('in_use');return e&&e.prompts?e.prompts.map(e=>({id:e.id||'',name:e.name||'未命名提示词',enabled:e.enabled||!1,content:e.content||''})):[]}catch(e){return console.error('获取预设提示词失败:',e),[]}}const ae={key:0,class:'fixed bottom-4 right-4 z-50'},le={class:'fixed inset-0 z-50 bg-white flex flex-col'},re={class:'flex-1 p-4 space-y-4 overflow-y-auto'},ce=['value'],se={class:'flex gap-2'},ie={key:0,value:''},de=['value'],ue={key:0,class:'border rounded-lg divide-y max-h-64 overflow-y-auto'},me=['onClick'],pe={class:'flex items-center justify-between'},fe={class:'flex-1 min-w-0'},ve={class:'text-sm font-medium truncate'},he={key:0,class:'text-xs text-gray-500 truncate mt-1'},be={key:0,class:'fas fa-check text-blue-500 ml-2'},ge={class:'flex flex-col gap-2 pt-2'},xe={key:0,class:'flex gap-2'},ye={id:'preset-branch-float',class:'fixed z-50 w-80 bg-white rounded-lg shadow-xl border bg-opacity-95 backdrop-blur-sm'},Ne={class:'flex items-center gap-2 p-3 border-b'},Ee=['value'],Ve={key:0,value:''},we=['value'],ke={key:0,class:'flex gap-1'},Be={class:'max-h-64 overflow-y-auto'},Ce={key:0,class:'p-4 text-center text-gray-500 text-sm'},Me={key:1,class:'divide-y'},Se=['onClick'],je={class:'flex items-center justify-between'},De={class:'flex-1 min-w-0'},Pe={class:'text-sm font-medium truncate'},_e={key:0,class:'text-xs text-gray-500 truncate mt-1'},Oe={key:0,class:'fas fa-check text-blue-500'},Ae=(0,r.defineComponent)({__name:'FloatingWindow',emits:['edit','rename','delete'],setup(e,{expose:t,emit:n}){const a=n,l=B({mobile:640}).smaller('mobile'),c=(0,r.ref)(!0),s=(0,r.ref)(null),i=(0,r.ref)([]),d=(0,r.ref)(''),u=(0,r.ref)([]),m=(0,r.ref)('');async function p(){try{const e=getLoadedPresetName();e&&(d.value=e,await f(d.value),m.value=ne(d.value)||'')}catch(e){console.error('加载当前预设失败:',e)}}async function f(e){try{u.value=te(e)}catch(e){console.error('加载分支列表失败:',e),u.value=[]}}async function v(){try{await f(d.value),m.value=ne(d.value)||''}catch(e){console.error('切换预设失败:',e),toastr.error('切换预设失败')}}async function h(){if(m.value)try{(function(e,t){const n=Q(),o=n[e];if(!o||!o.branches[t])return!1;const a=o.branches[t];try{const e=getPreset('in_use');return e&&e.prompts?(e.prompts.forEach(e=>{e.id&&a.promptsEnabled.hasOwnProperty(e.id)&&(e.enabled=a.promptsEnabled[e.id])}),replacePreset('in_use',e),o.activeBranch=t,X(n),!0):(console.error('无法获取当前预设'),!1)}catch(e){return console.error('切换分支失败:',e),!1}})(d.value,m.value)?(await f(d.value),toastr.success('切换分支成功')):toastr.error('切换分支失败')}catch(e){console.error('切换分支失败:',e),toastr.error('切换分支失败')}}async function b(e){m.value=e,await h()}function g(){c.value=!c.value}function x(){a('edit')}function y(){m.value&&a('rename',m.value)}function N(){m.value&&a('delete',m.value)}return(0,r.onMounted)(async()=>{await async function(){try{const e=await async function(){try{return getPresetNames()||[]}catch(e){return console.error('获取预设列表失败:',e),[]}}();i.value=e}catch(e){console.error('加载预设列表失败:',e),toastr.error('加载预设列表失败')}}(),await p(),l.value||(await(0,r.nextTick)(),function(){if(!s.value)return;const e=o()('#preset-branch-float');e.draggable({handle:s.value,containment:'window',stop:(e,t)=>{localStorage.setItem('preset-branch-position',JSON.stringify({left:t.position.left,top:t.position.top}))}});const t=localStorage.getItem('preset-branch-position');if(t)try{const{left:n,top:o}=JSON.parse(t);e.css({left:n,top:o})}catch(e){console.error('恢复悬浮窗位置失败:',e)}}())}),t({refreshPreset:p,refreshBranches:async()=>{d.value&&await f(d.value)}}),(e,t)=>((0,r.openBlock)(),(0,r.createElementBlock)(r.Fragment,null,[(0,r.createCommentVNode)(' 移动端：底部浮动按钮 '),(0,r.unref)(l)?((0,r.openBlock)(),(0,r.createElementBlock)('div',ae,[c.value?((0,r.openBlock)(),(0,r.createElementBlock)(r.Fragment,{key:1},[(0,r.createCommentVNode)(' 移动端全屏展开 '),(0,r.createElementVNode)('div',le,[(0,r.createElementVNode)('div',{class:'flex items-center justify-between border-b p-4 bg-white'},[t[6]||(t[6]=(0,r.createElementVNode)('h2',{class:'text-lg font-semibold'},'预设分支管理',-1)),(0,r.createElementVNode)('button',{onClick:g,class:'p-2 touch-manipulation'},[...t[5]||(t[5]=[(0,r.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,r.createElementVNode)('div',re,[(0,r.createCommentVNode)(' 预设选择 '),(0,r.createElementVNode)('div',null,[t[7]||(t[7]=(0,r.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'选择预设',-1)),(0,r.withDirectives)((0,r.createElementVNode)('select',{'onUpdate:modelValue':t[0]||(t[0]=e=>d.value=e),onChange:v,class:'w-full min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation bg-white'},[((0,r.openBlock)(!0),(0,r.createElementBlock)(r.Fragment,null,(0,r.renderList)(i.value,e=>((0,r.openBlock)(),(0,r.createElementBlock)('option',{key:e,value:e},(0,r.toDisplayString)(e),9,ce))),128))],544),[[r.vModelSelect,d.value]])]),(0,r.createCommentVNode)(' 分支选择 '),(0,r.createElementVNode)('div',null,[t[8]||(t[8]=(0,r.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'选择分支',-1)),(0,r.createElementVNode)('div',se,[(0,r.withDirectives)((0,r.createElementVNode)('select',{'onUpdate:modelValue':t[1]||(t[1]=e=>m.value=e),onChange:h,class:'flex-1 min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation bg-white'},[u.value.length?(0,r.createCommentVNode)('v-if',!0):((0,r.openBlock)(),(0,r.createElementBlock)('option',ie,'无分支')),((0,r.openBlock)(!0),(0,r.createElementBlock)(r.Fragment,null,(0,r.renderList)(u.value,e=>((0,r.openBlock)(),(0,r.createElementBlock)('option',{key:e.name,value:e.name},(0,r.toDisplayString)(e.name),9,de))),128))],544),[[r.vModelSelect,m.value]])])]),(0,r.createCommentVNode)(' 分支列表 '),u.value.length>0?((0,r.openBlock)(),(0,r.createElementBlock)('div',ue,[((0,r.openBlock)(!0),(0,r.createElementBlock)(r.Fragment,null,(0,r.renderList)(u.value,e=>((0,r.openBlock)(),(0,r.createElementBlock)('div',{key:e.name,onClick:t=>b(e.name),class:(0,r.normalizeClass)(['p-3 cursor-pointer touch-manipulation',e.isActive?'bg-blue-50':'hover:bg-gray-50'])},[(0,r.createElementVNode)('div',pe,[(0,r.createElementVNode)('div',fe,[(0,r.createElementVNode)('div',ve,(0,r.toDisplayString)(e.name),1),e.description?((0,r.openBlock)(),(0,r.createElementBlock)('div',he,(0,r.toDisplayString)(e.description),1)):(0,r.createCommentVNode)('v-if',!0)]),e.isActive?((0,r.openBlock)(),(0,r.createElementBlock)('i',be)):(0,r.createCommentVNode)('v-if',!0)])],10,me))),128))])):(0,r.createCommentVNode)('v-if',!0),(0,r.createCommentVNode)(' 操作按钮 '),(0,r.createElementVNode)('div',ge,[(0,r.createElementVNode)('button',{onClick:x,class:'w-full min-h-[44px] rounded-lg bg-blue-500 px-4 py-3 text-white font-medium touch-manipulation active:bg-blue-600'},[...t[9]||(t[9]=[(0,r.createElementVNode)('i',{class:'fas fa-edit mr-2'},null,-1),(0,r.createTextVNode)('修改条目 ',-1)])]),m.value?((0,r.openBlock)(),(0,r.createElementBlock)('div',xe,[(0,r.createElementVNode)('button',{onClick:y,class:'flex-1 min-h-[44px] rounded-lg bg-gray-200 px-4 py-3 font-medium touch-manipulation active:bg-gray-300'},[...t[10]||(t[10]=[(0,r.createElementVNode)('i',{class:'fas fa-edit mr-2'},null,-1),(0,r.createTextVNode)('重命名 ',-1)])]),(0,r.createElementVNode)('button',{onClick:N,class:'flex-1 min-h-[44px] rounded-lg bg-red-500 px-4 py-3 text-white font-medium touch-manipulation active:bg-red-600'},[...t[11]||(t[11]=[(0,r.createElementVNode)('i',{class:'fas fa-trash mr-2'},null,-1),(0,r.createTextVNode)('删除 ',-1)])])])):(0,r.createCommentVNode)('v-if',!0)])])])],2112)):((0,r.openBlock)(),(0,r.createElementBlock)('button',{key:0,onClick:g,class:'h-14 w-14 rounded-full bg-blue-500 shadow-lg touch-manipulation active:scale-95 flex items-center justify-center'},[...t[4]||(t[4]=[(0,r.createElementVNode)('i',{class:'fas fa-code-branch text-2xl text-white'},null,-1)])]))])):((0,r.openBlock)(),(0,r.createElementBlock)(r.Fragment,{key:1},[(0,r.createCommentVNode)(' 桌面端：悬浮窗 '),(0,r.createElementVNode)('div',ye,[(0,r.createCommentVNode)(' 折叠状态 '),c.value?((0,r.openBlock)(),(0,r.createElementBlock)(r.Fragment,{key:1},[(0,r.createCommentVNode)(' 展开状态 '),(0,r.createElementVNode)('div',null,[(0,r.createCommentVNode)(' 顶部栏 '),(0,r.createElementVNode)('div',{class:'flex items-center justify-between p-3 border-b cursor-move bg-gray-50 rounded-t-lg',ref_key:'dragHandle',ref:s},[t[14]||(t[14]=(0,r.createElementVNode)('span',{class:'text-sm font-medium'},'预设分支',-1)),(0,r.createElementVNode)('button',{onClick:g,class:'text-gray-400 hover:text-gray-600'},[...t[13]||(t[13]=[(0,r.createElementVNode)('i',{class:'fas fa-chevron-up'},null,-1)])])],512),(0,r.createCommentVNode)(' 工具栏 '),(0,r.createElementVNode)('div',Ne,[(0,r.createElementVNode)('button',{onClick:x,class:'px-3 py-1.5 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors'},' 修改 '),(0,r.withDirectives)((0,r.createElementVNode)('select',{'onUpdate:modelValue':t[2]||(t[2]=e=>d.value=e),onChange:v,class:'flex-1 text-sm border rounded px-2 py-1.5 bg-white cursor-pointer'},[((0,r.openBlock)(!0),(0,r.createElementBlock)(r.Fragment,null,(0,r.renderList)(i.value,e=>((0,r.openBlock)(),(0,r.createElementBlock)('option',{key:e,value:e},(0,r.toDisplayString)(e),9,Ee))),128))],544),[[r.vModelSelect,d.value]]),(0,r.withDirectives)((0,r.createElementVNode)('select',{'onUpdate:modelValue':t[3]||(t[3]=e=>m.value=e),onChange:h,class:'flex-1 text-sm border rounded px-2 py-1.5 bg-white cursor-pointer'},[u.value.length?(0,r.createCommentVNode)('v-if',!0):((0,r.openBlock)(),(0,r.createElementBlock)('option',Ve,'无分支')),((0,r.openBlock)(!0),(0,r.createElementBlock)(r.Fragment,null,(0,r.renderList)(u.value,e=>((0,r.openBlock)(),(0,r.createElementBlock)('option',{key:e.name,value:e.name},(0,r.toDisplayString)(e.name),9,we))),128))],544),[[r.vModelSelect,m.value]]),m.value?((0,r.openBlock)(),(0,r.createElementBlock)('div',ke,[(0,r.createElementVNode)('button',{onClick:y,class:'p-1.5 text-gray-500 hover:text-gray-700 transition-colors',title:'重命名'},[...t[15]||(t[15]=[(0,r.createElementVNode)('i',{class:'fas fa-edit text-xs'},null,-1)])]),(0,r.createElementVNode)('button',{onClick:N,class:'p-1.5 text-red-500 hover:text-red-700 transition-colors',title:'删除'},[...t[16]||(t[16]=[(0,r.createElementVNode)('i',{class:'fas fa-trash text-xs'},null,-1)])])])):(0,r.createCommentVNode)('v-if',!0)]),(0,r.createCommentVNode)(' 分支列表 '),(0,r.createElementVNode)('div',Be,[u.value.length?((0,r.openBlock)(),(0,r.createElementBlock)('div',Me,[((0,r.openBlock)(!0),(0,r.createElementBlock)(r.Fragment,null,(0,r.renderList)(u.value,e=>((0,r.openBlock)(),(0,r.createElementBlock)('div',{key:e.name,onClick:t=>b(e.name),class:(0,r.normalizeClass)(['p-3 cursor-pointer hover:bg-gray-50 transition-colors',e.isActive?'bg-blue-50 border-l-4 border-blue-500':''])},[(0,r.createElementVNode)('div',je,[(0,r.createElementVNode)('div',De,[(0,r.createElementVNode)('div',Pe,(0,r.toDisplayString)(e.name),1),e.description?((0,r.openBlock)(),(0,r.createElementBlock)('div',_e,(0,r.toDisplayString)(e.description),1)):(0,r.createCommentVNode)('v-if',!0)]),e.isActive?((0,r.openBlock)(),(0,r.createElementBlock)('i',Oe)):(0,r.createCommentVNode)('v-if',!0)])],10,Se))),128))])):((0,r.openBlock)(),(0,r.createElementBlock)('div',Ce,' 暂无分支 '))])])],2112)):((0,r.openBlock)(),(0,r.createElementBlock)('div',{key:0,class:'flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50',onClick:g},[...t[12]||(t[12]=[(0,r.createElementVNode)('span',{class:'text-sm font-medium'},'预设分支',-1),(0,r.createElementVNode)('i',{class:'fas fa-chevron-down text-gray-400'},null,-1)])]))])],2112))],2112))}}),$e={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},Te={class:'flex items-center justify-between border-b p-4 bg-gray-50'},ze={class:'flex-1 overflow-y-auto p-4 space-y-4'},Ie={class:'px-4 py-3 bg-gray-100 rounded-lg text-sm text-gray-600'},Le=['placeholder'],Fe={key:0,class:'text-red-500 text-sm mt-1'},Re={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},We=['disabled'],Ue=(0,r.defineComponent)({__name:'RenameBranchModal',props:{oldName:{},existingBranches:{}},emits:['close','rename'],setup(e,{emit:t}){const n=e,o=t,a=B({mobile:640}).smaller('mobile'),l=(0,r.ref)(n.oldName),c=(0,r.computed)(()=>l.value?l.value===n.oldName?'新名称与原名称相同':n.existingBranches.includes(l.value)?'分支名称已存在':'':'分支名称不能为空');function s(){c.value||o('rename',l.value)}return(t,n)=>((0,r.openBlock)(),(0,r.createElementBlock)('div',$e,[(0,r.createElementVNode)('div',{class:(0,r.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,r.unref)(a)}])},[(0,r.createCommentVNode)(' 标题栏 '),(0,r.createElementVNode)('div',Te,[n[4]||(n[4]=(0,r.createElementVNode)('h2',{class:'text-lg font-semibold'},'重命名分支',-1)),(0,r.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[3]||(n[3]=[(0,r.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,r.createCommentVNode)(' 内容区 '),(0,r.createElementVNode)('div',ze,[(0,r.createCommentVNode)(' 当前分支名称 '),(0,r.createElementVNode)('div',null,[n[5]||(n[5]=(0,r.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'当前分支名称',-1)),(0,r.createElementVNode)('div',Ie,(0,r.toDisplayString)(e.oldName),1)]),(0,r.createCommentVNode)(' 新分支名称 '),(0,r.createElementVNode)('div',null,[n[6]||(n[6]=(0,r.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},[(0,r.createTextVNode)(' 新分支名称 '),(0,r.createElementVNode)('span',{class:'text-red-500'},'*')],-1)),(0,r.withDirectives)((0,r.createElementVNode)('input',{'onUpdate:modelValue':n[1]||(n[1]=e=>l.value=e),type:'text',placeholder:e.oldName,class:(0,r.normalizeClass)(['w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation',{'border-red-500':c.value}])},null,10,Le),[[r.vModelText,l.value]]),c.value?((0,r.openBlock)(),(0,r.createElementBlock)('p',Fe,(0,r.toDisplayString)(c.value),1)):(0,r.createCommentVNode)('v-if',!0)])]),(0,r.createCommentVNode)(' 底部按钮 '),(0,r.createElementVNode)('div',Re,[(0,r.createElementVNode)('button',{onClick:n[2]||(n[2]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,r.createElementVNode)('button',{onClick:s,disabled:!l.value||!!c.value,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors touch-manipulation min-h-[44px]'},' 重命名 ',8,We)])],2)]))}}),qe={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},Ge={class:'flex items-center justify-between border-b p-4 bg-gray-50'},Je={class:'flex-1 overflow-y-auto p-4 space-y-4'},He={key:0,class:'text-red-500 text-sm mt-1'},Ye={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},Ze=['disabled'],Ke=(0,r.defineComponent)({__name:'SaveBranchModal',props:{existingBranches:{}},emits:['close','save'],setup(e,{emit:t}){const n=e,o=t,a=B({mobile:640}).smaller('mobile'),l=(0,r.ref)(''),c=(0,r.ref)(''),s=(0,r.computed)(()=>l.value?n.existingBranches.includes(l.value)?'分支名称已存在':'':'分支名称不能为空');function i(){s.value||o('save',l.value,c.value)}return(e,t)=>((0,r.openBlock)(),(0,r.createElementBlock)('div',qe,[(0,r.createElementVNode)('div',{class:(0,r.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,r.unref)(a)}])},[(0,r.createCommentVNode)(' 标题栏 '),(0,r.createElementVNode)('div',Ge,[t[5]||(t[5]=(0,r.createElementVNode)('h2',{class:'text-lg font-semibold'},'保存为新分支',-1)),(0,r.createElementVNode)('button',{onClick:t[0]||(t[0]=t=>e.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...t[4]||(t[4]=[(0,r.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,r.createCommentVNode)(' 内容区 '),(0,r.createElementVNode)('div',Je,[(0,r.createCommentVNode)(' 分支名称 '),(0,r.createElementVNode)('div',null,[t[6]||(t[6]=(0,r.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},[(0,r.createTextVNode)(' 分支名称 '),(0,r.createElementVNode)('span',{class:'text-red-500'},'*')],-1)),(0,r.withDirectives)((0,r.createElementVNode)('input',{'onUpdate:modelValue':t[1]||(t[1]=e=>l.value=e),type:'text',placeholder:'输入分支名称',class:(0,r.normalizeClass)(['w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation',{'border-red-500':s.value}])},null,2),[[r.vModelText,l.value]]),s.value?((0,r.openBlock)(),(0,r.createElementBlock)('p',He,(0,r.toDisplayString)(s.value),1)):(0,r.createCommentVNode)('v-if',!0)]),(0,r.createCommentVNode)(' 分支描述 '),(0,r.createElementVNode)('div',null,[t[7]||(t[7]=(0,r.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'描述（可选）',-1)),(0,r.withDirectives)((0,r.createElementVNode)('textarea',{'onUpdate:modelValue':t[2]||(t[2]=e=>c.value=e),placeholder:'输入分支描述',rows:'3',class:'w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation resize-none'},null,512),[[r.vModelText,c.value]])])]),(0,r.createCommentVNode)(' 底部按钮 '),(0,r.createElementVNode)('div',Ye,[(0,r.createElementVNode)('button',{onClick:t[3]||(t[3]=t=>e.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,r.createElementVNode)('button',{onClick:i,disabled:!l.value||!!s.value,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors touch-manipulation min-h-[44px]'},' 保存 ',8,Ze)])],2)]))}});async function Qe(){if(console.info('[预设分支管理] 脚本初始化开始'),'undefined'==typeof getPreset||'undefined'==typeof replacePreset)return console.error('[预设分支管理] 预设接口不可用'),void toastr.error('预设分支管理：预设接口不可用');const t=(0,r.createApp)({components:{FloatingWindow:Ae,EditPromptsModal:Z,SaveBranchModal:Ke,RenameBranchModal:Ue,DeleteBranchModal:A},setup(){const e=(0,r.ref)(!1),t=(0,r.ref)(!1),n=(0,r.ref)(!1),o=(0,r.ref)(!1),a=(0,r.ref)([]),c=(0,r.ref)(''),s=(0,r.ref)(''),i=(0,r.ref)(''),d=(0,r.ref)(''),u=(0,r.ref)(''),m=(0,r.ref)(''),p=(0,r.ref)(null);eventOn(tavern_events.PRESET_CHANGED,async()=>{console.info('[预设分支管理] 预设已变更，刷新界面'),p.value&&await p.value.refreshPreset()});const f=l().debounce(()=>{try{const e=getLoadedPresetName();if(e&&ne(e)){!function(e,t){const n=Q(),o=n[e];if(!o||!o.activeBranch)return;const a=o.activeBranch;o.branches[a]&&(o.branches[a].promptsEnabled={...t},o.branches[a].updatedAt=Date.now(),X(n))}(e,function(){const e=oe(),t={};return e.forEach(e=>{e.id&&(t[e.id]=e.enabled)}),t}())}}catch(e){console.error('[预设分支管理] 更新激活分支失败:',e)}},1e3);let v=null;return setInterval(()=>{try{const e=getPreset('in_use'),t=JSON.stringify(e.prompts?.map(e=>({id:e.id,enabled:e.enabled})));v&&v!==t&&(console.info('[预设分支管理] 检测到预设变更'),f()),v=t}catch(e){}},2e3),{showEditModal:e,showSaveModal:t,showRenameModal:n,showDeleteModal:o,editPrompts:a,editPresetName:c,saveBranchName:s,saveBranchDescription:i,renameOldName:d,renameNewName:u,deleteBranchName:m,floatingWindowRef:p,openEditModal:function(){try{c.value=getLoadedPresetName()||'未知预设',a.value=oe(),e.value=!0}catch(e){console.error('[预设分支管理] 打开编辑弹窗失败:',e),toastr.error('打开编辑弹窗失败')}},openSaveBranchModal:function(e){a.value.forEach(t=>{t.id&&e.hasOwnProperty(t.id)&&(t.enabled=e[t.id])});const n=getLoadedPresetName();if(n){te(n).map(e=>e.name);t.value=!0}},saveNewBranch:function(e,n){try{const o={};a.value.forEach(e=>{e.id&&(o[e.id]=e.enabled)});const l=getLoadedPresetName();if(!l)return void toastr.error('无法获取当前预设名称');const r=function(e,t,n,o){const a=Q();a[e]||(a[e]={activeBranch:null,branches:{}});const l=a[e];if(l.branches[t])return!1;const r=Date.now(),c={promptsEnabled:{...n},createdAt:r,updatedAt:r,description:o};return l.branches[t]=c,l.activeBranch=t,X(a),!0}(l,e,o,n);r?(t.value=!1,s.value='',i.value='',p.value&&p.value.refreshBranches(),toastr.success(`分支 "${e}" 创建成功`)):toastr.error('分支创建失败，可能名称已存在')}catch(e){console.error('[预设分支管理] 保存分支失败:',e),toastr.error('保存分支失败')}},openRenameModal:function(e){d.value=e,u.value=e,n.value=!0},renameBranchAction:function(e){try{const t=getLoadedPresetName();if(!t)return void toastr.error('无法获取当前预设名称');(function(e,t,n){const o=Q(),a=o[e];return!(!a||!a.branches[t]||a.branches[n]||(a.branches[n]={...a.branches[t],updatedAt:Date.now()},a.activeBranch===t&&(a.activeBranch=n),delete a.branches[t],X(o),0))})(t,d.value,e)?(n.value=!1,d.value='',u.value='',p.value&&p.value.refreshBranches(),toastr.success('分支重命名成功')):toastr.error('分支重命名失败，可能名称已存在')}catch(e){console.error('[预设分支管理] 重命名分支失败:',e),toastr.error('重命名分支失败')}},openDeleteModal:function(e){m.value=e,o.value=!0},deleteBranchAction:function(){try{const e=getLoadedPresetName();if(!e)return void toastr.error('无法获取当前预设名称');(function(e,t){const n=Q(),o=n[e];if(!o||!o.branches[t])return!1;if(o.activeBranch===t){const e=Object.keys(o.branches).filter(e=>e!==t);o.activeBranch=e.length>0?e[0]:null}return delete o.branches[t],0===Object.keys(o.branches).length&&delete n[e],X(n),!0})(e,m.value)?(o.value=!1,m.value='',p.value&&p.value.refreshBranches(),toastr.success('分支删除成功')):toastr.error('分支删除失败')}catch(e){console.error('[预设分支管理] 删除分支失败:',e),toastr.error('删除分支失败')}},getExistingBranchNames:()=>{const e=getLoadedPresetName();return e?te(e).map(e=>e.name):[]}}},template:'\n      <div>\n        <FloatingWindow ref="floatingWindowRef" @edit="openEditModal" @rename="openRenameModal" @delete="openDeleteModal" />\n        <EditPromptsModal v-if="showEditModal" :preset-name="editPresetName" :prompts="editPrompts" @close="showEditModal = false" @saveAsNewBranch="openSaveBranchModal" />\n        <SaveBranchModal v-if="showSaveModal" :existing-branches="getExistingBranchNames()" @close="showSaveModal = false" @save="saveNewBranch" />\n        <RenameBranchModal v-if="showRenameModal" :old-name="renameOldName" :existing-branches="getExistingBranchNames()" @close="showRenameModal = false" @rename="renameBranchAction" />\n        <DeleteBranchModal v-if="showDeleteModal" :branch-name="deleteBranchName" @close="showDeleteModal = false" @delete="deleteBranchAction" />\n      </div>\n    '}),n=e();t.use(n);const a=function(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}(),c=$('<div>').attr('script_id',getScriptId()).appendTo('body');t.mount(c[0]),console.info('[预设分支管理] 脚本初始化完成'),toastr.success('预设分支管理已加载'),o()(window).on('pagehide',()=>{t.unmount(),c.remove(),a(),console.info('[预设分支管理] 脚本已卸载')})}o()(()=>{errorCatched(Qe)()});
//# sourceMappingURL=index.js.map