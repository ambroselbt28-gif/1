# 预设分支功能开发工作单

## 项目概述
为酒馆助手的预设系统添加分支功能，允许用户为同一个预设保存多个不同的开关条目配置，便于在不同场景间快速切换。

**重要要求：界面必须适配移动端，支持在手机等小屏幕设备上流畅使用。**

## 界面设计

### 整体布局（悬浮窗）
```
┌─────────────────────────────────────────────────────┐
│  [修改]  [预设选择框 ▼]    当前预设名  [分支选择 ▼] │  ← 顶部工具栏
├─────────────────────────────────────────────────────┤
│                                                     │
│                   分支列表区域                        │  ← 主要内容区
│              （显示当前预设的分支）                   │
│                                                     │
│                                                     │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 修改弹窗（点击"修改"按钮后）
```
┌─────────────────────────────────────────────────────┐
│  当前预设：预设名                                    │
├─────────────────────────────────────────────────────┤
│  ☑ 提示词1                                          │
│  ☐ 提示词2                                          │
│  ☑ 提示词3                                          │
│  ...                                               │
│                                                     │
│  [取消]                          [保存为新分支]      │
└─────────────────────────────────────────────────────┘
```

### 保存为新分支弹窗
```
┌─────────────────────────────────────────────────────┐
│  保存为新分支                                        │
├─────────────────────────────────────────────────────┤
│  分支名称：[________________]                       │
│  描述：    [________________]                       │
│           [________________]                       │
│                                                     │
│  [取消]                          [保存]            │
└─────────────────────────────────────────────────────┘
```

## 功能需求分析

### 核心功能

1. **悬浮窗界面**
   - 固定悬浮在页面右上角（可拖动）
   - 包含预设选择框、分支选择框、修改按钮
   - 点击最小化/展开按钮控制显示状态

2. **预设选择**
   - 下拉框显示所有可用预设
   - 选择预设后加载该预设的分支列表
   - 显示当前预设名称

3. **分支选择**
   - 下拉框显示当前预设的所有分支
   - 选择分支后立即切换
   - 标记当前激活分支

4. **修改功能**
   - 点击"修改"按钮打开预设条目编辑弹窗
   - 显示当前预设的所有提示词条目
   - 可以勾选/取消勾选条目的开关状态
   - 点击"保存为新分支"按钮保存当前配置
   - 输入分支名称和描述
   - 保存后自动切换到新分支

5. **分支管理**
   - **重命名分支**：重命名当前选中的分支
   - **删除分支**：删除当前选中的分支（需确认）
   - 分支操作按钮放在分支选择框旁边

6. **移动端适配**
   - 悬浮窗在移动端改为底部按钮（点击展开全屏）
   - 移动端全屏模式时，预设和分支选择改为顶部切换
   - 修改弹窗在移动端全屏显示
   - 触摸优化，操作按钮尺寸适合手指

### 技术要点
- 使用 `getPreset('in_use')` 获取当前预设
- 使用 `replacePreset('in_use', preset)` 更新预设
- 使用 `getVariables({type: 'script', script_id: getScriptId()})` 存储分支数据
- 使用 `replaceVariables()` 保存分支数据
- 使用 TailwindCSS 实现响应式设计
- 使用 jQuery UI 实现悬浮窗拖动

## 数据结构设计

### 脚本变量结构
```typescript
interface PresetBranchesData {
  // 以预设名称为键，存储该预设的所有分支
  [presetName: string]: {
    // 当前激活的分支名称
    activeBranch: string;
    // 所有分支配置
    branches: {
      [branchName: string]: {
        // 每个提示词的 enabled 状态
        promptsEnabled: Record<string, boolean>;
        // 创建时间
        createdAt: number;
        // 最后修改时间
        updatedAt: number;
        // 可选的描述
        description?: string;
      };
    };
  };
}
```

## 实现步骤

### Phase 1: 基础框架搭建
- [ ] 1.1 在 `src/` 下创建新项目文件夹 `预设分支管理/`
- [ ] 1.2 创建 `index.ts` 文件，初始化脚本结构
- [ ] 1.3 创建脚本 JSON 配置文件用于导入酒馆
- [ ] 1.4 实现脚本加载时的初始化逻辑

### Phase 2: 数据管理模块
- [ ] 2.1 定义分支数据类型的 TypeScript 接口
- [ ] 2.2 实现从脚本变量读取分支数据的函数
- [ ] 2.3 实现将分支数据保存到脚本变量的函数
- [ ] 2.4 实现分支数据的校验和默认值处理

### Phase 3: 分支操作核心功能
- [ ] 3.1 实现创建分支功能
  - 从当前 `in_use` 预设读取所有提示词的 enabled 状态
  - 保存为新分支
  - 验证分支名称唯一性
- [ ] 3.2 实现删除分支功能
  - 检查是否为当前激活分支
  - 删除分支数据
  - 自动切换到其他分支或无分支状态
- [ ] 3.3 实现重命名分支功能
  - 更新分支名称
  - 保持分支数据不变
  - 如果是激活分支，更新 activeBranch 字段
- [ ] 3.4 实现切换分支功能
  - 读取目标分支的 promptsEnabled 数据
  - 将 enabled 状态应用到 `in_use` 预设
  - 调用 `replacePreset` 更新预设
  - 更新 activeBranch 字段
- [ ] 3.5 实现更新当前分支功能
  - 当用户手动修改提示词开关时
  - 自动更新当前激活分支的 promptsEnabled
  - 监听预设变更事件实现自动保存

### Phase 4: 悬浮窗界面开发
- [ ] 4.1 创建 Vue 组件 `FloatingWindow.vue`
  - 实现悬浮窗基本结构
  - 添加最小化/展开功能
  - 添加预设选择框（下拉框）
  - 添加分支选择框（下拉框）
  - 添加"修改"按钮
  - 添加重命名分支按钮
  - 添加删除分支按钮
- [ ] 4.2 实现悬浮窗拖动功能
  - 使用 jQuery UI draggable
  - 记住悬浮窗位置
- [ ] 4.3 实现预设切换逻辑
  - 监听预设选择框变化
  - 加载新预设的分支数据
  - 更新分支选择框选项
- [ ] 4.4 实现分支切换逻辑
  - 监听分支选择框变化
  - 调用切换分支功能
  - 更新界面显示

### Phase 5: 修改弹窗开发
- [ ] 5.1 创建 Vue 组件 `EditPromptsModal.vue`
  - 显示当前预设名称
  - 显示所有提示词条目列表
  - 每个条目显示名称和开关状态
  - 勾选框控制开关状态
- [ ] 5.2 实现"保存为新分支"功能
  - 点击后打开保存弹窗
  - 传递当前开关状态数据
  - 提供取消按钮返回修改界面
- [ ] 5.3 创建 Vue 组件 `SaveBranchModal.vue`
  - 分支名称输入框
  - 分支描述输入框
  - 保存按钮
  - 取消按钮
- [ ] 5.4 实现保存逻辑
  - 验证分支名称唯一性
  - 创建新分支
  - 自动切换到新分支
  - 关闭所有弹窗

### Phase 6: 分支管理弹窗
- [ ] 6.1 创建重命名分支弹窗
  - 显示当前分支名称
  - 输入新名称
  - 验证名称唯一性
  - 保存/取消按钮
- [ ] 6.2 创建删除分支确认弹窗
  - 显示要删除的分支名称
  - 警告提示
  - 确认/取消按钮
- [ ] 6.3 实现重命名逻辑
  - 验证新名称
  - 更新分支名称
  - 更新界面显示
- [ ] 6.4 实现删除逻辑
  - 验证不是激活分支（或是则先切换）
  - 删除分支数据
  - 更新界面显示

### Phase 7: 移动端适配
- [ ] 7.1 响应式布局设计
  - 桌面端：右上角悬浮窗
  - 移动端：右下角浮动按钮，点击展开全屏
  - 全屏模式时重新布局界面元素
- [ ] 7.2 移动端交互优化
  - 悬浮窗改为底部 FAB 按钮
  - 点击后展开全屏界面
  - 全屏界面包含所有功能
  - 修改弹窗在移动端全屏显示
- [ ] 7.3 触摸优化
  - 按钮最小触摸目标尺寸 44x44px
  - 列表项高度适合触摸滑动
  - 下拉框改为点击展开的选择器
  - 添加触摸反馈动画
- [ ] 7.4 移动端专项测试
  - iOS Safari 测试
  - Android Chrome 测试
  - 不同屏幕尺寸测试
  - 横竖屏切换测试

### Phase 8: 事件监听和自动化
- [ ] 8.1 监听预设加载事件
  - 当预设切换时，自动加载对应的分支数据
  - 更新界面显示
- [ ] 8.2 监听提示词开关变更
  - 检测 `in_use` 预设的 prompts.enabled 变化
  - 自动更新当前激活分支数据
- [ ] 8.3 监听预设保存事件
  - 当用户保存预设时，同步更新分支数据
- [ ] 8.4 实现防抖机制
  - 避免频繁更新分支数据

### Phase 9: 错误处理和边界情况
- [ ] 9.1 处理预设不存在的情况
- [ ] 9.2 处理分支名称冲突
- [ ] 9.3 处理删除激活分支的情况
- [ ] 9.4 处理分支数据损坏的情况（回退到默认值）
- [ ] 9.5 处理网络错误和存储错误
- [ ] 9.6 添加操作提示和错误提示

## 文件结构

```
src/预设分支管理/
├── index.ts                    # 主入口文件
├── types.ts                    # 类型定义
├── branch-manager.ts           # 分支管理核心逻辑
├── preset-watcher.ts           # 预设监听模块
├── FloatingWindow.vue          # 悬浮窗主组件
├── EditPromptsModal.vue        # 修改预设条目弹窗
├── SaveBranchModal.vue        # 保存为新分支弹窗
├── RenameBranchModal.vue      # 重命名分支弹窗
├── DeleteBranchModal.vue      # 删除分支确认弹窗
├── 导入到酒馆中/
│   └── 预设分支管理-实时修改.json
```

## 关键代码示例

### 类型定义 (types.ts)
```typescript
export interface PromptEnabledState {
  [promptId: string]: boolean;
}

export interface BranchData {
  promptsEnabled: PromptEnabledState;
  createdAt: number;
  updatedAt: number;
  description?: string;
}

export interface PresetBranches {
  activeBranch: string | null;
  branches: Record<string, BranchData>;
}

export interface PresetBranchesStorage {
  [presetName: string]: PresetBranches;
}
```

### 悬浮窗组件示例 (FloatingWindow.vue)
```vue
<template>
  <!-- 移动端：底部浮动按钮 -->
  <div v-if="isMobile" class="fixed bottom-4 right-4 z-50">
    <button v-if="!isExpanded" 
            @click="toggleExpand"
            class="h-14 w-14 rounded-full bg-blue-500 shadow-lg touch-manipulation active:scale-95">
      <i class="fas fa-code-branch text-2xl text-white"></i>
    </button>
    
    <!-- 移动端全屏展开 -->
    <div v-else class="fixed inset-0 z-50 bg-white flex flex-col">
      <div class="flex items-center justify-between border-b p-4">
        <h2 class="text-lg font-semibold">预设分支管理</h2>
        <button @click="toggleExpand" class="p-2 touch-manipulation">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="flex-1 p-4 space-y-4">
        <!-- 预设选择 -->
        <div>
          <label class="block text-sm font-medium mb-2">选择预设</label>
          <select v-model="selectedPreset" 
                  @change="onPresetChange"
                  class="w-full min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation">
            <option v-for="preset in presetNames" :key="preset" :value="preset">
              {{ preset }}
            </option>
          </select>
        </div>
        
        <!-- 分支选择 -->
        <div>
          <label class="block text-sm font-medium mb-2">选择分支</label>
          <div class="flex gap-2">
            <select v-model="selectedBranch" 
                    @change="onBranchChange"
                    class="flex-1 min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation">
              <option v-if="!branches.length" value="">无分支</option>
              <option v-for="branch in branches" :key="branch.name" :value="branch.name">
                {{ branch.name }}
              </option>
            </select>
          </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex flex-col gap-2">
          <button @click="openEditModal" 
                  class="w-full min-h-[44px] rounded-lg bg-blue-500 px-4 py-3 text-white font-medium touch-manipulation">
            <i class="fas fa-edit mr-2"></i>修改条目
          </button>
          
          <div v-if="selectedBranch" class="flex gap-2">
            <button @click="openRenameModal" 
                    class="flex-1 min-h-[44px] rounded-lg bg-gray-200 px-4 py-3 font-medium touch-manipulation">
              <i class="fas fa-edit mr-2"></i>重命名
            </button>
            <button @click="openDeleteModal" 
                    class="flex-1 min-h-[44px] rounded-lg bg-red-500 px-4 py-3 text-white font-medium touch-manipulation">
              <i class="fas fa-trash mr-2"></i>删除
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 桌面端：悬浮窗 -->
  <div v-else 
       id="preset-branch-float"
       class="fixed top-20 right-4 z-50 w-80 bg-white rounded-lg shadow-xl border">
    <!-- 折叠状态 -->
    <div v-if="!isExpanded"
         class="flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50"
         @click="toggleExpand">
      <span class="text-sm font-medium">预设分支</span>
      <i class="fas fa-chevron-down text-gray-400"></i>
    </div>
    
    <!-- 展开状态 -->
    <div v-else>
      <!-- 顶部栏 -->
      <div class="flex items-center justify-between p-3 border-b cursor-move" ref="dragHandle">
        <span class="text-sm font-medium">预设分支</span>
        <button @click="toggleExpand" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-chevron-up"></i>
        </button>
      </div>
      
      <!-- 工具栏 -->
      <div class="flex items-center gap-2 p-3 border-b">
        <button @click="openEditModal" 
                class="px-3 py-1.5 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
          修改
        </button>
        
        <select v-model="selectedPreset" 
                @change="onPresetChange"
                class="flex-1 text-sm border rounded px-2 py-1.5">
          <option v-for="preset in presetNames" :key="preset" :value="preset">
            {{ preset }}
          </option>
        </select>
        
        <select v-model="selectedBranch" 
                @change="onBranchChange"
                class="flex-1 text-sm border rounded px-2 py-1.5">
          <option v-if="!branches.length" value="">无分支</option>
          <option v-for="branch in branches" :key="branch.name" :value="branch.name">
            {{ branch.name }}
          </option>
        </select>
        
        <div v-if="selectedBranch" class="flex gap-1">
          <button @click="openRenameModal" 
                  class="p-1.5 text-gray-500 hover:text-gray-700" title="重命名">
            <i class="fas fa-edit text-xs"></i>
          </button>
          <button @click="openDeleteModal" 
                  class="p-1.5 text-red-500 hover:text-red-700" title="删除">
            <i class="fas fa-trash text-xs"></i>
          </button>
        </div>
      </div>
      
      <!-- 分支列表 -->
      <div class="max-h-64 overflow-y-auto">
        <div v-if="!branches.length" class="p-4 text-center text-gray-500 text-sm">
          暂无分支
        </div>
        <div v-else class="divide-y">
          <div v-for="branch in branches" 
               :key="branch.name"
               @click="switchToBranch(branch.name)"
               :class="[
                 'p-3 cursor-pointer hover:bg-gray-50',
                 branch.name === selectedBranch ? 'bg-blue-50 border-l-4 border-blue-500' : ''
               ]">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-medium">{{ branch.name }}</div>
                <div v-if="branch.description" class="text-xs text-gray-500 mt-1">
                  {{ branch.description }}
                </div>
              </div>
              <i v-if="branch.name === selectedBranch" 
                 class="fas fa-check text-blue-500"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted } from 'vue';
import { useBreakpoints } from '@vueuse/core';
import $ from 'jquery';
import 'jquery-ui';

const breakpoints = useBreakpoints({
  mobile: 640,
});

const isMobile = breakpoints.smaller('mobile');
const isExpanded = ref(false);
const dragHandle = ref<HTMLElement | null>(null);

// 预设和分支数据
const presetNames = ref<string[]>([]);
const selectedPreset = ref('');
const branches = ref<BranchData[]>([]);
const selectedBranch = ref('');

// 初始化悬浮窗拖动
onMounted(() => {
  if (!isMobile.value && dragHandle.value) {
    $('#preset-branch-float').draggable({
      handle: dragHandle.value,
      stop: (event, ui) => {
        // 保存位置
        localStorage.setItem('preset-branch-position', 
          JSON.stringify({ left: ui.position.left, top: ui.position.top }));
      }
    });
    
    // 恢复位置
    const saved = localStorage.getItem('preset-branch-position');
    if (saved) {
      const { left, top } = JSON.parse(saved);
      $('#preset-branch-float').css({ left, top });
    }
  }
});

function toggleExpand() {
  isExpanded.value = !isExpanded.value;
}
</script>
```

### 修改条目弹窗 (EditPromptsModal.vue)
```vue
<template>
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-xl"
         :class="{ 'h-full rounded-none': isMobile }">
      <div class="flex items-center justify-between border-b p-4">
        <h2 class="text-lg font-semibold">修改预设条目</h2>
        <button @click="$emit('close')" class="p-2 touch-manipulation">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="p-4">
        <div class="mb-4">
          <span class="text-sm text-gray-600">当前预设：</span>
          <span class="font-medium">{{ presetName }}</span>
        </div>
        
        <div class="space-y-2 max-h-96 overflow-y-auto">
          <div v-for="prompt in prompts" 
               :key="prompt.id"
               class="flex items-center justify-between p-3 border rounded"
               :class="{ 'bg-blue-50': prompt.enabled }">
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium truncate">{{ prompt.name }}</div>
              <div v-if="prompt.content" class="text-xs text-gray-500 truncate mt-1">
                {{ prompt.content }}
              </div>
            </div>
            <input type="checkbox" 
                   v-model="prompt.enabled"
                   class="ml-3 w-5 h-5 rounded touch-manipulation">
          </div>
        </div>
      </div>
      
      <div class="flex justify-end gap-3 border-t p-4">
        <button @click="$emit('close')" 
                class="px-4 py-2 text-gray-600 hover:text-gray-800">
          取消
        </button>
        <button @click="saveAsNewBranch" 
                class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 touch-manipulation">
          保存为新分支
        </button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { useBreakpoints } from '@vueuse/core';

const props = defineProps<{
  presetName: string;
  prompts: PresetPrompt[];
}>();

const emit = defineEmits<{
  close: [];
  saveAsNewBranch: [enabledState: Record<string, boolean>];
}>();

const breakpoints = useBreakpoints({ mobile: 640 });
const isMobile = breakpoints.smaller('mobile');

function saveAsNewBranch() {
  const enabledState: Record<string, boolean> = {};
  props.prompts.forEach(prompt => {
    enabledState[prompt.id] = prompt.enabled;
  });
  emit('saveAsNewBranch', enabledState);
}
</script>
```

### 保存分支弹窗 (SaveBranchModal.vue)
```vue
<template>
  <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
    <div class="w-full max-w-md bg-white rounded-lg shadow-xl"
         :class="{ 'h-full rounded-none': isMobile }">
      <div class="flex items-center justify-between border-b p-4">
        <h2 class="text-lg font-semibold">保存为新分支</h2>
        <button @click="$emit('close')" class="p-2 touch-manipulation">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">分支名称 *</label>
          <input v-model="branchName" 
                 type="text"
                 placeholder="输入分支名称"
                 class="w-full min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation">
          <p v-if="error" class="text-red-500 text-sm mt-1">{{ error }}</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">描述</label>
          <textarea v-model="description" 
                    placeholder="输入分支描述（可选）"
                    rows="3"
                    class="w-full min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation"></textarea>
        </div>
      </div>
      
      <div class="flex justify-end gap-3 border-t p-4">
        <button @click="$emit('close')" 
                class="px-4 py-2 text-gray-600 hover:text-gray-800">
          取消
        </button>
        <button @click="handleSave" 
                :disabled="!branchName || !!error"
                class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed touch-manipulation">
          保存
        </button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { useBreakpoints } from '@vueuse/core';

const props = defineProps<{
  existingBranches: string[];
}>();

const emit = defineEmits<{
  close: [];
  save: [name: string, description: string];
}>();

const breakpoints = useBreakpoints({ mobile: 640 });
const isMobile = breakpoints.smaller('mobile');

const branchName = ref('');
const description = ref('');

const error = computed(() => {
  if (!branchName.value) return '分支名称不能为空';
  if (props.existingBranches.includes(branchName.value)) {
    return '分支名称已存在';
  }
  return '';
});

function handleSave() {
  if (!error.value) {
    emit('save', branchName.value, description.value);
  }
}
</script>
```

## 技术栈
- TypeScript
- Vue 3 (Composition API)
- Pinia (状态管理)
- jQuery (DOM 操作)
- jQuery UI (拖动功能)
- TailwindCSS (响应式样式设计)
- @vueuse/core (响应式工具库)
- 酒馆助手接口

## 预计开发时间
- Phase 1-2: 基础框架和数据管理 (2-3小时)
- Phase 3: 分支操作核心功能 (2-3小时)
- Phase 4: 悬浮窗界面开发 (3-4小时)
- Phase 5-6: 弹窗开发 (3-4小时)
- Phase 7: 移动端适配 (2-3小时)
- Phase 8-9: 事件监听和错误处理 (2-3小时)
- 测试和调试 (2-3小时)

**总计: 约 18-27 小时**

## 后续扩展建议
1. 支持分支的导出/导入，便于分享配置
2. 添加分支模板功能
3. 支持预设级别的分支继承
4. 添加暗黑模式适配
5. 支持快捷键操作（桌面端）
