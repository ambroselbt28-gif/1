import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import'https://testingcf.jsdelivr.net/npm/jquery-ui/+esm';import'https://testingcf.jsdelivr.net/npm/function/preset/+esm';var t={};t.n=e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},t.d=(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},t.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const n=$;var o=t.n(n);const a=_;var l=t.n(a);const r=toastr;var c=t.n(r);const s=Vue;function i(e){return!!(0,s.getCurrentScope)()&&((0,s.onScopeDispose)(e),!0)}const d=new WeakMap,u=(...e)=>{var t;const n=e[0],o=null==(t=(0,s.getCurrentInstance)())?void 0:t.proxy;if(null==o&&!(0,s.hasInjectionContext)())throw new Error('injectLocal must be called in setup');return o&&d.has(o)&&n in d.get(o)?d.get(o)[n]:(0,s.inject)(...e)};const m='undefined'!=typeof window&&'undefined'!=typeof document,p=('undefined'!=typeof WorkerGlobalScope&&(globalThis,WorkerGlobalScope),Object.prototype.toString),f=e=>'[object Object]'===p.call(e);function v(e){return e.endsWith('rem')?16*Number.parseFloat(e):Number.parseFloat(e)}function h(e){return Array.isArray(e)?e:[e]}function b(e){const t=Object.create(null);return n=>t[n]||(t[n]=e(n))}const g=/\B([A-Z])/g,x=(b(e=>e.replace(g,'-$1').toLowerCase()),/-(\w)/g);b(e=>e.replace(x,(_,e)=>e?e.toUpperCase():''));function y(e){return e||(0,s.getCurrentInstance)()}const N=m?window:void 0;m&&window.document,m&&window.navigator,m&&window.location;function E(e){var t;const n=(0,s.toValue)(e);return null!=(t=null==n?void 0:n.$el)?t:n}function V(...e){const t=[],n=()=>{t.forEach(e=>e()),t.length=0},o=(0,s.computed)(()=>{const t=h((0,s.toValue)(e[0])).filter(e=>null!=e);return t.every(e=>'string'!=typeof e)?t:void 0}),a=(l=()=>{var t,n;return[null!=(n=null==(t=o.value)?void 0:t.map(e=>E(e)))?n:[N].filter(e=>null!=e),h((0,s.toValue)(o.value?e[1]:e[0])),h((0,s.unref)(o.value?e[2]:e[1])),(0,s.toValue)(o.value?e[3]:e[2])]},r=([e,o,a,l])=>{if(n(),!(null==e?void 0:e.length)||!(null==o?void 0:o.length)||!(null==a?void 0:a.length))return;const r=f(l)?{...l}:l;t.push(...e.flatMap(e=>o.flatMap(t=>a.map(n=>((e,t,n,o)=>(e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)))(e,t,n,r)))))},c={flush:'post'},(0,s.watch)(l,r,{...c,immediate:!0}));var l,r,c;return i(n),()=>{a(),n()}}function w(e){const t=function(){const e=(0,s.shallowRef)(!1),t=(0,s.getCurrentInstance)();return t&&(0,s.onMounted)(()=>{e.value=!0},t),e}();return(0,s.computed)(()=>(t.value,Boolean(e())))}const k=Symbol('vueuse-ssr-width');function B(){const e=(0,s.hasInjectionContext)()?u(k,null):null;return'number'==typeof e?e:void 0}function C(e,t={}){const{window:n=N,ssrWidth:o=B()}=t,a=w(()=>n&&'matchMedia'in n&&'function'==typeof n.matchMedia),l=(0,s.shallowRef)('number'==typeof o),r=(0,s.shallowRef)(),c=(0,s.shallowRef)(!1);return(0,s.watchEffect)(()=>{if(l.value){l.value=!a.value;const t=(0,s.toValue)(e).split(',');return void(c.value=t.some(e=>{const t=e.includes('not all'),n=e.match(/\(\s*min-width:\s*(-?\d+(?:\.\d*)?[a-z]+\s*)\)/),a=e.match(/\(\s*max-width:\s*(-?\d+(?:\.\d*)?[a-z]+\s*)\)/);let l=Boolean(n||a);return n&&l&&(l=o>=v(n[1])),a&&l&&(l=o<=v(a[1])),t?!l:l}))}a.value&&(r.value=n.matchMedia((0,s.toValue)(e)),c.value=r.value.matches)}),V(r,'change',e=>{c.value=e.matches},{passive:!0}),(0,s.computed)(()=>c.value)}function M(e,t={}){function n(t,n){let o=(0,s.toValue)(e[(0,s.toValue)(t)]);return null!=n&&(o=function(e,t){var n;if('number'==typeof e)return e+t;const o=(null==(n=e.match(/^-?\d+\.?\d*/))?void 0:n[0])||'',a=e.slice(o.length),l=Number.parseFloat(o)+t;return Number.isNaN(l)?e:l+a}(o,n)),'number'==typeof o&&(o=`${o}px`),o}const{window:o=N,strategy:a='min-width',ssrWidth:l=B()}=t,r='number'==typeof l,c=r?(0,s.shallowRef)(!1):{value:!0};function i(e,t){return!c.value&&r?'min'===e?l>=v(t):l<=v(t):!!o&&o.matchMedia(`(${e}-width: ${t})`).matches}r&&function(e,t=!0,n){y(n)?(0,s.onMounted)(e,n):t?e():(0,s.nextTick)(e)}(()=>c.value=!!o);const d=e=>C(()=>`(min-width: ${n(e)})`,t),u=e=>C(()=>`(max-width: ${n(e)})`,t),m=Object.keys(e).reduce((e,t)=>(Object.defineProperty(e,t,{get:()=>'min-width'===a?d(t):u(t),enumerable:!0,configurable:!0}),e),{});function p(){const t=Object.keys(e).map(e=>[e,m[e],v(n(e))]).sort((e,t)=>e[2]-t[2]);return(0,s.computed)(()=>t.filter(([,e])=>e.value).map(([e])=>e))}return Object.assign(m,{greaterOrEqual:d,smallerOrEqual:u,greater:e=>C(()=>`(min-width: ${n(e,.1)})`,t),smaller:e=>C(()=>`(max-width: ${n(e,-.1)})`,t),between:(e,o)=>C(()=>`(min-width: ${n(e)}) and (max-width: ${n(o,-.1)})`,t),isGreater:e=>i('min',n(e,.1)),isGreaterOrEqual:e=>i('min',n(e)),isSmaller:e=>i('max',n(e,-.1)),isSmallerOrEqual:e=>i('max',n(e)),isInBetween:(e,t)=>i('min',n(e))&&i('max',n(t,-.1)),current:p,active(){const e=p();return(0,s.computed)(()=>0===e.value.length?'':e.value.at('min-width'===a?-1:0))}})}'undefined'!=typeof globalThis?globalThis:'undefined'!=typeof window?window:'undefined'!=typeof globalThis?globalThis:'undefined'!=typeof self&&self;Number.POSITIVE_INFINITY;const S={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},j={class:'flex items-center justify-between border-b p-4 bg-gray-50'},D={class:'flex-1 overflow-y-auto p-6'},P={class:'text-center space-y-2'},O={class:'text-gray-600'},A={class:'font-semibold text-gray-900'},T={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},I=(0,s.defineComponent)({__name:'DeleteBranchModal',props:{branchName:{}},emits:['close','delete'],setup(e,{emit:t}){const n=t,o=M({mobile:640}).smaller('mobile');function a(){n('delete')}return(t,n)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',S,[(0,s.createElementVNode)('div',{class:(0,s.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,s.unref)(o)}])},[(0,s.createCommentVNode)(' 标题栏 '),(0,s.createElementVNode)('div',j,[n[3]||(n[3]=(0,s.createElementVNode)('h2',{class:'text-lg font-semibold'},'删除分支',-1)),(0,s.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[2]||(n[2]=[(0,s.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,s.createCommentVNode)(' 内容区 '),(0,s.createElementVNode)('div',D,[(0,s.createCommentVNode)(' 警告图标 '),n[7]||(n[7]=(0,s.createElementVNode)('div',{class:'flex justify-center mb-4'},[(0,s.createElementVNode)('div',{class:'w-16 h-16 rounded-full bg-red-100 flex items-center justify-center'},[(0,s.createElementVNode)('i',{class:'fas fa-exclamation-triangle text-3xl text-red-500'})])],-1)),(0,s.createCommentVNode)(' 警告文字 '),(0,s.createElementVNode)('div',P,[n[6]||(n[6]=(0,s.createElementVNode)('h3',{class:'text-lg font-semibold text-gray-900'},'确定要删除此分支吗？',-1)),(0,s.createElementVNode)('p',O,[n[4]||(n[4]=(0,s.createTextVNode)(' 分支 ',-1)),(0,s.createElementVNode)('span',A,'"'+(0,s.toDisplayString)(e.branchName)+'"',1),n[5]||(n[5]=(0,s.createTextVNode)(' 将被永久删除，此操作无法撤销。 ',-1))])])]),(0,s.createCommentVNode)(' 底部按钮 '),(0,s.createElementVNode)('div',T,[(0,s.createElementVNode)('button',{onClick:n[1]||(n[1]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,s.createElementVNode)('button',{onClick:a,class:'px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 active:bg-red-700 transition-colors touch-manipulation min-h-[44px]'},' 删除 ')])],2)]))}}),L={class:'fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4'},F={class:'flex items-center justify-between border-b p-4 bg-gray-50'},R={class:'flex-1 overflow-y-auto p-4'},W={class:'mb-4'},U={class:'font-medium'},q={class:'space-y-2'},G={class:'flex-1 min-w-0 pr-3'},J={class:'text-sm font-medium truncate'},H={key:0,class:'text-xs text-gray-500 truncate mt-1'},Y=['onUpdate:modelValue'],Z={key:0,class:'p-8 text-center text-gray-500 text-sm'},K={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},Q=(0,s.defineComponent)({__name:'EditPromptsModal',props:{presetName:{},prompts:{}},emits:['close','saveAsNewBranch'],setup(e,{emit:t}){const n=e,o=t,a=M({mobile:640}).smaller('mobile');function l(){const e={};n.prompts.forEach(t=>{t.id&&(e[t.id]=t.enabled)}),o('saveAsNewBranch',e)}return(t,n)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',L,[(0,s.createElementVNode)('div',{class:(0,s.normalizeClass)(['w-full max-w-2xl bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,s.unref)(a)}])},[(0,s.createCommentVNode)(' 标题栏 '),(0,s.createElementVNode)('div',F,[n[3]||(n[3]=(0,s.createElementVNode)('h2',{class:'text-lg font-semibold'},'修改预设条目',-1)),(0,s.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[2]||(n[2]=[(0,s.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,s.createCommentVNode)(' 内容区 '),(0,s.createElementVNode)('div',R,[(0,s.createElementVNode)('div',W,[n[4]||(n[4]=(0,s.createElementVNode)('span',{class:'text-sm text-gray-600'},'当前预设：',-1)),(0,s.createElementVNode)('span',U,(0,s.toDisplayString)(e.presetName),1)]),(0,s.createElementVNode)('div',q,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(e.prompts,e=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:e.id,class:(0,s.normalizeClass)(['flex items-center justify-between p-3 border rounded-lg transition-colors',{'bg-blue-50 border-blue-300':e.enabled,'hover:bg-gray-50':!e.enabled}])},[(0,s.createElementVNode)('div',G,[(0,s.createElementVNode)('div',J,(0,s.toDisplayString)(e.name),1),e.content?((0,s.openBlock)(),(0,s.createElementBlock)('div',H,(0,s.toDisplayString)(e.content),1)):(0,s.createCommentVNode)('v-if',!0)]),(0,s.withDirectives)((0,s.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':t=>e.enabled=t,class:'w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500 touch-manipulation cursor-pointer'},null,8,Y),[[s.vModelCheckbox,e.enabled]])],2))),128)),e.prompts.length?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)('div',Z,' 暂无提示词条目 '))])]),(0,s.createCommentVNode)(' 底部按钮 '),(0,s.createElementVNode)('div',K,[(0,s.createElementVNode)('button',{onClick:n[1]||(n[1]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,s.createElementVNode)('button',{onClick:l,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors touch-manipulation min-h-[44px]'},' 保存为新分支 ')])],2)]))}}),X='preset_branches';function ee(){return getVariables({type:'script',script_id:getScriptId()})[X]||{}}function te(e){replaceVariables({...getVariables({type:'script',script_id:getScriptId()}),[X]:e},{type:'script',script_id:getScriptId()})}function ne(e){return ee()[e]||null}function oe(e){const t=ne(e);return t&&t.branches?Object.entries(t.branches).map(([e,n])=>({name:e,description:n.description,createdAt:n.createdAt,updatedAt:n.updatedAt,isActive:e===t.activeBranch})):[]}function ae(e){const t=ne(e);return t?.activeBranch||null}function le(){try{const e=getPreset('in_use');return e&&e.prompts?e.prompts.map(e=>({id:e.id||'',name:e.name||'未命名提示词',enabled:e.enabled||!1,content:e.content||''})):[]}catch(e){return console.error('获取预设提示词失败:',e),[]}}const re={key:0,class:'fixed bottom-4 right-4 z-50'},ce={class:'fixed inset-0 z-50 bg-white flex flex-col'},se={class:'flex-1 p-4 space-y-4 overflow-y-auto'},ie=['value'],de={class:'flex gap-2'},ue={key:0,value:''},me=['value'],pe={key:0,class:'border rounded-lg divide-y max-h-64 overflow-y-auto'},fe=['onClick'],ve={class:'flex items-center justify-between'},he={class:'flex-1 min-w-0'},be={class:'text-sm font-medium truncate'},ge={key:0,class:'text-xs text-gray-500 truncate mt-1'},xe={key:0,class:'fas fa-check text-blue-500 ml-2'},ye={class:'flex flex-col gap-2 pt-2'},Ne={key:0,class:'flex gap-2'},Ee={id:'preset-branch-float',class:'fixed z-50 w-80 bg-white rounded-lg shadow-xl border border-gray-200',style:{left:'50%',top:'50%',transform:'translate(-50%, -50%)'}},Ve={class:'flex items-center gap-2 p-3 border-b'},we=['value'],ke={key:0,value:''},Be=['value'],Ce={key:0,class:'flex gap-1'},Me={class:'max-h-64 overflow-y-auto'},Se={key:0,class:'p-4 text-center text-gray-500 text-sm'},je={key:1,class:'divide-y'},De=['onClick'],Pe={class:'flex items-center justify-between'},_e={class:'flex-1 min-w-0'},Oe={class:'text-sm font-medium truncate'},Ae={key:0,class:'text-xs text-gray-500 truncate mt-1'},$e={key:0,class:'fas fa-check text-blue-500'},Te=(0,s.defineComponent)({__name:'FloatingWindow',emits:['edit','rename','delete'],setup(e,{expose:t,emit:n}){const a=n,l=M({mobile:640}).smaller('mobile'),r=(0,s.ref)(!0),i=(0,s.ref)(null),d=(0,s.ref)([]),u=(0,s.ref)(''),m=(0,s.ref)([]),p=(0,s.ref)('');async function f(){try{const e=function(){try{return getLoadedPresetName()}catch(e){return console.error('获取当前预设名称失败:',e),''}}();e&&(u.value=e,await v(u.value),p.value=ae(u.value)||'')}catch(e){console.error('加载当前预设失败:',e)}}async function v(e){try{m.value=oe(e)}catch(e){console.error('加载分支列表失败:',e),m.value=[]}}async function h(){try{await v(u.value),p.value=ae(u.value)||''}catch(e){console.error('切换预设失败:',e),c().error('切换预设失败')}}async function b(){if(p.value)try{(function(e,t){const n=ee(),o=n[e];if(!o||!o.branches[t])return!1;const a=o.branches[t];try{const e=getPreset('in_use');return e&&e.prompts?(e.prompts.forEach(e=>{e.id&&a.promptsEnabled.hasOwnProperty(e.id)&&(e.enabled=a.promptsEnabled[e.id])}),replacePreset('in_use',e),o.activeBranch=t,te(n),!0):(console.error('无法获取当前预设'),!1)}catch(e){return console.error('切换分支失败:',e),!1}})(u.value,p.value)?(await v(u.value),c().success('切换分支成功')):c().error('切换分支失败')}catch(e){console.error('切换分支失败:',e),c().error('切换分支失败')}}async function g(e){p.value=e,await b()}function x(){r.value=!r.value}function y(){a('edit')}function N(){p.value&&a('rename',p.value)}function E(){p.value&&a('delete',p.value)}return(0,s.onMounted)(async()=>{await async function(){try{const e=await async function(){try{return getPresetNames()||[]}catch(e){return console.error('获取预设列表失败:',e),[]}}();d.value=e}catch(e){console.error('加载预设列表失败:',e),c().error('加载预设列表失败')}}(),await f(),l.value||(await(0,s.nextTick)(),function(){if(!i.value)return;const e=o()('#preset-branch-float');e.draggable({handle:i.value,containment:'window',stop:(e,t)=>{localStorage.setItem('preset-branch-position',JSON.stringify({left:t.position.left,top:t.position.top}))}});const t=localStorage.getItem('preset-branch-position');if(t)try{const{left:n,top:o}=JSON.parse(t);e.css({left:n,top:o})}catch(e){console.error('恢复悬浮窗位置失败:',e)}}())}),t({refreshPreset:f,refreshBranches:async()=>{u.value&&await v(u.value)}}),(e,t)=>((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,null,[(0,s.createCommentVNode)(' 移动端：底部浮动按钮 '),(0,s.unref)(l)?((0,s.openBlock)(),(0,s.createElementBlock)('div',re,[r.value?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.createCommentVNode)(' 移动端全屏展开 '),(0,s.createElementVNode)('div',ce,[(0,s.createElementVNode)('div',{class:'flex items-center justify-between border-b p-4 bg-white'},[t[6]||(t[6]=(0,s.createElementVNode)('h2',{class:'text-lg font-semibold'},'预设分支管理',-1)),(0,s.createElementVNode)('button',{onClick:x,class:'p-2 touch-manipulation'},[...t[5]||(t[5]=[(0,s.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,s.createElementVNode)('div',se,[(0,s.createCommentVNode)(' 预设选择 '),(0,s.createElementVNode)('div',null,[t[7]||(t[7]=(0,s.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'选择预设',-1)),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':t[0]||(t[0]=e=>u.value=e),onChange:h,class:'w-full min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation bg-white'},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(d.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e,value:e},(0,s.toDisplayString)(e),9,ie))),128))],544),[[s.vModelSelect,u.value]])]),(0,s.createCommentVNode)(' 分支选择 '),(0,s.createElementVNode)('div',null,[t[8]||(t[8]=(0,s.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'选择分支',-1)),(0,s.createElementVNode)('div',de,[(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':t[1]||(t[1]=e=>p.value=e),onChange:b,class:'flex-1 min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation bg-white'},[m.value.length?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)('option',ue,'无分支')),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(m.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.name,value:e.name},(0,s.toDisplayString)(e.name),9,me))),128))],544),[[s.vModelSelect,p.value]])])]),(0,s.createCommentVNode)(' 分支列表 '),m.value.length>0?((0,s.openBlock)(),(0,s.createElementBlock)('div',pe,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(m.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:e.name,onClick:t=>g(e.name),class:(0,s.normalizeClass)(['p-3 cursor-pointer touch-manipulation',e.isActive?'bg-blue-50':'hover:bg-gray-50'])},[(0,s.createElementVNode)('div',ve,[(0,s.createElementVNode)('div',he,[(0,s.createElementVNode)('div',be,(0,s.toDisplayString)(e.name),1),e.description?((0,s.openBlock)(),(0,s.createElementBlock)('div',ge,(0,s.toDisplayString)(e.description),1)):(0,s.createCommentVNode)('v-if',!0)]),e.isActive?((0,s.openBlock)(),(0,s.createElementBlock)('i',xe)):(0,s.createCommentVNode)('v-if',!0)])],10,fe))),128))])):(0,s.createCommentVNode)('v-if',!0),(0,s.createCommentVNode)(' 操作按钮 '),(0,s.createElementVNode)('div',ye,[(0,s.createElementVNode)('button',{onClick:y,class:'w-full min-h-[44px] rounded-lg bg-blue-500 px-4 py-3 text-white font-medium touch-manipulation active:bg-blue-600'},[...t[9]||(t[9]=[(0,s.createElementVNode)('i',{class:'fas fa-edit mr-2'},null,-1),(0,s.createTextVNode)('修改条目 ',-1)])]),p.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Ne,[(0,s.createElementVNode)('button',{onClick:N,class:'flex-1 min-h-[44px] rounded-lg bg-gray-200 px-4 py-3 font-medium touch-manipulation active:bg-gray-300'},[...t[10]||(t[10]=[(0,s.createElementVNode)('i',{class:'fas fa-edit mr-2'},null,-1),(0,s.createTextVNode)('重命名 ',-1)])]),(0,s.createElementVNode)('button',{onClick:E,class:'flex-1 min-h-[44px] rounded-lg bg-red-500 px-4 py-3 text-white font-medium touch-manipulation active:bg-red-600'},[...t[11]||(t[11]=[(0,s.createElementVNode)('i',{class:'fas fa-trash mr-2'},null,-1),(0,s.createTextVNode)('删除 ',-1)])])])):(0,s.createCommentVNode)('v-if',!0)])])])],2112)):((0,s.openBlock)(),(0,s.createElementBlock)('button',{key:0,onClick:x,class:'h-14 w-14 rounded-full bg-blue-500 shadow-lg touch-manipulation active:scale-95 flex items-center justify-center'},[...t[4]||(t[4]=[(0,s.createElementVNode)('i',{class:'fas fa-code-branch text-2xl text-white'},null,-1)])]))])):((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.createCommentVNode)(' 桌面端：悬浮窗 '),(0,s.createElementVNode)('div',Ee,[(0,s.createCommentVNode)(' 折叠状态 '),r.value?((0,s.openBlock)(),(0,s.createElementBlock)(s.Fragment,{key:1},[(0,s.createCommentVNode)(' 展开状态 '),(0,s.createElementVNode)('div',null,[(0,s.createCommentVNode)(' 顶部栏 '),(0,s.createElementVNode)('div',{class:'flex items-center justify-between p-3 border-b cursor-move bg-gray-50 rounded-t-lg',ref_key:'dragHandle',ref:i},[t[14]||(t[14]=(0,s.createElementVNode)('span',{class:'text-sm font-medium'},'预设分支',-1)),(0,s.createElementVNode)('button',{onClick:x,class:'text-gray-400 hover:text-gray-600'},[...t[13]||(t[13]=[(0,s.createElementVNode)('i',{class:'fas fa-chevron-up'},null,-1)])])],512),(0,s.createCommentVNode)(' 工具栏 '),(0,s.createElementVNode)('div',Ve,[(0,s.createElementVNode)('button',{onClick:y,class:'px-3 py-1.5 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors'},' 修改 '),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':t[2]||(t[2]=e=>u.value=e),onChange:h,class:'flex-1 text-sm border rounded px-2 py-1.5 bg-white cursor-pointer'},[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(d.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e,value:e},(0,s.toDisplayString)(e),9,we))),128))],544),[[s.vModelSelect,u.value]]),(0,s.withDirectives)((0,s.createElementVNode)('select',{'onUpdate:modelValue':t[3]||(t[3]=e=>p.value=e),onChange:b,class:'flex-1 text-sm border rounded px-2 py-1.5 bg-white cursor-pointer'},[m.value.length?(0,s.createCommentVNode)('v-if',!0):((0,s.openBlock)(),(0,s.createElementBlock)('option',ke,'无分支')),((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(m.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('option',{key:e.name,value:e.name},(0,s.toDisplayString)(e.name),9,Be))),128))],544),[[s.vModelSelect,p.value]]),p.value?((0,s.openBlock)(),(0,s.createElementBlock)('div',Ce,[(0,s.createElementVNode)('button',{onClick:N,class:'p-1.5 text-gray-500 hover:text-gray-700 transition-colors',title:'重命名'},[...t[15]||(t[15]=[(0,s.createElementVNode)('i',{class:'fas fa-edit text-xs'},null,-1)])]),(0,s.createElementVNode)('button',{onClick:E,class:'p-1.5 text-red-500 hover:text-red-700 transition-colors',title:'删除'},[...t[16]||(t[16]=[(0,s.createElementVNode)('i',{class:'fas fa-trash text-xs'},null,-1)])])])):(0,s.createCommentVNode)('v-if',!0)]),(0,s.createCommentVNode)(' 分支列表 '),(0,s.createElementVNode)('div',Me,[m.value.length?((0,s.openBlock)(),(0,s.createElementBlock)('div',je,[((0,s.openBlock)(!0),(0,s.createElementBlock)(s.Fragment,null,(0,s.renderList)(m.value,e=>((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:e.name,onClick:t=>g(e.name),class:(0,s.normalizeClass)(['p-3 cursor-pointer hover:bg-gray-50 transition-colors',e.isActive?'bg-blue-50 border-l-4 border-blue-500':''])},[(0,s.createElementVNode)('div',Pe,[(0,s.createElementVNode)('div',_e,[(0,s.createElementVNode)('div',Oe,(0,s.toDisplayString)(e.name),1),e.description?((0,s.openBlock)(),(0,s.createElementBlock)('div',Ae,(0,s.toDisplayString)(e.description),1)):(0,s.createCommentVNode)('v-if',!0)]),e.isActive?((0,s.openBlock)(),(0,s.createElementBlock)('i',$e)):(0,s.createCommentVNode)('v-if',!0)])],10,De))),128))])):((0,s.openBlock)(),(0,s.createElementBlock)('div',Se,' 暂无分支 '))])])],2112)):((0,s.openBlock)(),(0,s.createElementBlock)('div',{key:0,class:'flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50',onClick:x},[...t[12]||(t[12]=[(0,s.createElementVNode)('span',{class:'text-sm font-medium'},'预设分支',-1),(0,s.createElementVNode)('i',{class:'fas fa-chevron-down text-gray-400'},null,-1)])]))])],2112))],2112))}}),ze={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},Ie={class:'flex items-center justify-between border-b p-4 bg-gray-50'},Le={class:'flex-1 overflow-y-auto p-4 space-y-4'},Fe={class:'px-4 py-3 bg-gray-100 rounded-lg text-sm text-gray-600'},Re=['placeholder'],We={key:0,class:'text-red-500 text-sm mt-1'},Ue={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},qe=['disabled'],Ge=(0,s.defineComponent)({__name:'RenameBranchModal',props:{oldName:{},existingBranches:{}},emits:['close','rename'],setup(e,{emit:t}){const n=e,o=t,a=M({mobile:640}).smaller('mobile'),l=(0,s.ref)(n.oldName),r=(0,s.computed)(()=>l.value?l.value===n.oldName?'新名称与原名称相同':n.existingBranches.includes(l.value)?'分支名称已存在':'':'分支名称不能为空');function c(){r.value||o('rename',l.value)}return(t,n)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',ze,[(0,s.createElementVNode)('div',{class:(0,s.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,s.unref)(a)}])},[(0,s.createCommentVNode)(' 标题栏 '),(0,s.createElementVNode)('div',Ie,[n[4]||(n[4]=(0,s.createElementVNode)('h2',{class:'text-lg font-semibold'},'重命名分支',-1)),(0,s.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[3]||(n[3]=[(0,s.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,s.createCommentVNode)(' 内容区 '),(0,s.createElementVNode)('div',Le,[(0,s.createCommentVNode)(' 当前分支名称 '),(0,s.createElementVNode)('div',null,[n[5]||(n[5]=(0,s.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'当前分支名称',-1)),(0,s.createElementVNode)('div',Fe,(0,s.toDisplayString)(e.oldName),1)]),(0,s.createCommentVNode)(' 新分支名称 '),(0,s.createElementVNode)('div',null,[n[6]||(n[6]=(0,s.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},[(0,s.createTextVNode)(' 新分支名称 '),(0,s.createElementVNode)('span',{class:'text-red-500'},'*')],-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':n[1]||(n[1]=e=>l.value=e),type:'text',placeholder:e.oldName,class:(0,s.normalizeClass)(['w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation',{'border-red-500':r.value}])},null,10,Re),[[s.vModelText,l.value]]),r.value?((0,s.openBlock)(),(0,s.createElementBlock)('p',We,(0,s.toDisplayString)(r.value),1)):(0,s.createCommentVNode)('v-if',!0)])]),(0,s.createCommentVNode)(' 底部按钮 '),(0,s.createElementVNode)('div',Ue,[(0,s.createElementVNode)('button',{onClick:n[2]||(n[2]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,s.createElementVNode)('button',{onClick:c,disabled:!l.value||!!r.value,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors touch-manipulation min-h-[44px]'},' 重命名 ',8,qe)])],2)]))}}),Je={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},He={class:'flex items-center justify-between border-b p-4 bg-gray-50'},Ye={class:'flex-1 overflow-y-auto p-4 space-y-4'},Ze={key:0,class:'text-red-500 text-sm mt-1'},Ke={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},Qe=['disabled'],Xe=(0,s.defineComponent)({__name:'SaveBranchModal',props:{existingBranches:{}},emits:['close','save'],setup(e,{emit:t}){const n=e,o=t,a=M({mobile:640}).smaller('mobile'),l=(0,s.ref)(''),r=(0,s.ref)(''),c=(0,s.computed)(()=>l.value?n.existingBranches.includes(l.value)?'分支名称已存在':'':'分支名称不能为空');function i(){c.value||o('save',l.value,r.value)}return(e,t)=>((0,s.openBlock)(),(0,s.createElementBlock)('div',Je,[(0,s.createElementVNode)('div',{class:(0,s.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,s.unref)(a)}])},[(0,s.createCommentVNode)(' 标题栏 '),(0,s.createElementVNode)('div',He,[t[5]||(t[5]=(0,s.createElementVNode)('h2',{class:'text-lg font-semibold'},'保存为新分支',-1)),(0,s.createElementVNode)('button',{onClick:t[0]||(t[0]=t=>e.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...t[4]||(t[4]=[(0,s.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,s.createCommentVNode)(' 内容区 '),(0,s.createElementVNode)('div',Ye,[(0,s.createCommentVNode)(' 分支名称 '),(0,s.createElementVNode)('div',null,[t[6]||(t[6]=(0,s.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},[(0,s.createTextVNode)(' 分支名称 '),(0,s.createElementVNode)('span',{class:'text-red-500'},'*')],-1)),(0,s.withDirectives)((0,s.createElementVNode)('input',{'onUpdate:modelValue':t[1]||(t[1]=e=>l.value=e),type:'text',placeholder:'输入分支名称',class:(0,s.normalizeClass)(['w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation',{'border-red-500':c.value}])},null,2),[[s.vModelText,l.value]]),c.value?((0,s.openBlock)(),(0,s.createElementBlock)('p',Ze,(0,s.toDisplayString)(c.value),1)):(0,s.createCommentVNode)('v-if',!0)]),(0,s.createCommentVNode)(' 分支描述 '),(0,s.createElementVNode)('div',null,[t[7]||(t[7]=(0,s.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'描述（可选）',-1)),(0,s.withDirectives)((0,s.createElementVNode)('textarea',{'onUpdate:modelValue':t[2]||(t[2]=e=>r.value=e),placeholder:'输入分支描述',rows:'3',class:'w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation resize-none'},null,512),[[s.vModelText,r.value]])])]),(0,s.createCommentVNode)(' 底部按钮 '),(0,s.createElementVNode)('div',Ke,[(0,s.createElementVNode)('button',{onClick:t[3]||(t[3]=t=>e.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,s.createElementVNode)('button',{onClick:i,disabled:!l.value||!!c.value,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors touch-manipulation min-h-[44px]'},' 保存 ',8,Qe)])],2)]))}});async function et(){if(console.info('[预设分支管理] 脚本初始化开始'),'undefined'==typeof getPreset||'undefined'==typeof replacePreset)return console.error('[预设分支管理] 预设接口不可用'),void c().error('预设分支管理：预设接口不可用');const t=(0,s.createApp)({components:{FloatingWindow:Te,EditPromptsModal:Q,SaveBranchModal:Xe,RenameBranchModal:Ge,DeleteBranchModal:I},setup(){const e=(0,s.ref)(!1),t=(0,s.ref)(!1),n=(0,s.ref)(!1),o=(0,s.ref)(!1),a=(0,s.ref)([]),r=(0,s.ref)(''),i=(0,s.ref)(''),d=(0,s.ref)(''),u=(0,s.ref)(''),m=(0,s.ref)(''),p=(0,s.ref)(''),f=(0,s.ref)(null);eventOn(tavern_events.PRESET_CHANGED,async()=>{console.info('[预设分支管理] 预设已变更，刷新界面'),f.value&&await f.value.refreshPreset()});const v=l().debounce(()=>{try{const e=getLoadedPresetName();if(e&&ae(e)){!function(e,t){const n=ee(),o=n[e];if(!o||!o.activeBranch)return;const a=o.activeBranch;o.branches[a]&&(o.branches[a].promptsEnabled={...t},o.branches[a].updatedAt=Date.now(),te(n))}(e,function(){const e=le(),t={};return e.forEach(e=>{e.id&&(t[e.id]=e.enabled)}),t}())}}catch(e){console.error('[预设分支管理] 更新激活分支失败:',e)}},1e3);let h=null;return setInterval(()=>{try{const e=getPreset('in_use'),t=JSON.stringify(e.prompts?.map(e=>({id:e.id,enabled:e.enabled})));h&&h!==t&&(console.info('[预设分支管理] 检测到预设变更'),v()),h=t}catch(e){}},2e3),{showEditModal:e,showSaveModal:t,showRenameModal:n,showDeleteModal:o,editPrompts:a,editPresetName:r,saveBranchName:i,saveBranchDescription:d,renameOldName:u,renameNewName:m,deleteBranchName:p,floatingWindowRef:f,openEditModal:function(){try{r.value=getLoadedPresetName()||'未知预设',a.value=le(),e.value=!0}catch(e){console.error('[预设分支管理] 打开编辑弹窗失败:',e),c().error('打开编辑弹窗失败')}},openSaveBranchModal:function(e){a.value.forEach(t=>{t.id&&e.hasOwnProperty(t.id)&&(t.enabled=e[t.id])});const n=getLoadedPresetName();if(n){oe(n).map(e=>e.name);t.value=!0}},saveNewBranch:function(e,n){try{const o={};a.value.forEach(e=>{e.id&&(o[e.id]=e.enabled)});const l=getLoadedPresetName();if(!l)return void c().error('无法获取当前预设名称');const r=function(e,t,n,o){const a=ee();a[e]||(a[e]={activeBranch:null,branches:{}});const l=a[e];if(l.branches[t])return!1;const r=Date.now(),c={promptsEnabled:{...n},createdAt:r,updatedAt:r,description:o};return l.branches[t]=c,l.activeBranch=t,te(a),!0}(l,e,o,n);r?(t.value=!1,i.value='',d.value='',f.value&&f.value.refreshBranches(),c().success(`分支 "${e}" 创建成功`)):c().error('分支创建失败，可能名称已存在')}catch(e){console.error('[预设分支管理] 保存分支失败:',e),c().error('保存分支失败')}},openRenameModal:function(e){u.value=e,m.value=e,n.value=!0},renameBranchAction:function(e){try{const t=getLoadedPresetName();if(!t)return void c().error('无法获取当前预设名称');(function(e,t,n){const o=ee(),a=o[e];return!(!a||!a.branches[t]||a.branches[n]||(a.branches[n]={...a.branches[t],updatedAt:Date.now()},a.activeBranch===t&&(a.activeBranch=n),delete a.branches[t],te(o),0))})(t,u.value,e)?(n.value=!1,u.value='',m.value='',f.value&&f.value.refreshBranches(),c().success('分支重命名成功')):c().error('分支重命名失败，可能名称已存在')}catch(e){console.error('[预设分支管理] 重命名分支失败:',e),c().error('重命名分支失败')}},openDeleteModal:function(e){p.value=e,o.value=!0},deleteBranchAction:function(){try{const e=getLoadedPresetName();if(!e)return void c().error('无法获取当前预设名称');(function(e,t){const n=ee(),o=n[e];if(!o||!o.branches[t])return!1;if(o.activeBranch===t){const e=Object.keys(o.branches).filter(e=>e!==t);o.activeBranch=e.length>0?e[0]:null}return delete o.branches[t],0===Object.keys(o.branches).length&&delete n[e],te(n),!0})(e,p.value)?(o.value=!1,p.value='',f.value&&f.value.refreshBranches(),c().success('分支删除成功')):c().error('分支删除失败')}catch(e){console.error('[预设分支管理] 删除分支失败:',e),c().error('删除分支失败')}},getExistingBranchNames:()=>{const e=getLoadedPresetName();return e?oe(e).map(e=>e.name):[]}}},template:'\n      <div>\n        <FloatingWindow ref="floatingWindowRef" @edit="openEditModal" @rename="openRenameModal" @delete="openDeleteModal" />\n        <EditPromptsModal v-if="showEditModal" :preset-name="editPresetName" :prompts="editPrompts" @close="showEditModal = false" @saveAsNewBranch="openSaveBranchModal" />\n        <SaveBranchModal v-if="showSaveModal" :existing-branches="getExistingBranchNames()" @close="showSaveModal = false" @save="saveNewBranch" />\n        <RenameBranchModal v-if="showRenameModal" :old-name="renameOldName" :existing-branches="getExistingBranchNames()" @close="showRenameModal = false" @rename="renameBranchAction" />\n        <DeleteBranchModal v-if="showDeleteModal" :branch-name="deleteBranchName" @close="showDeleteModal = false" @delete="deleteBranchAction" />\n      </div>\n    '}),n=e();t.use(n);const{destroy:a}=function(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}(),r=$('<div>').attr('script_id',getScriptId()).appendTo('body');t.mount(r[0]),console.info('[预设分支管理] 脚本初始化完成'),c().success('预设分支管理已加载'),o()(window).on('pagehide',()=>{t.unmount(),r.remove(),a(),console.info('[预设分支管理] 脚本已卸载')})}o()(()=>{errorCatched(et)()});
//# sourceMappingURL=index.js.map