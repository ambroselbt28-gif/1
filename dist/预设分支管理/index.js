import{createPinia as e}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import'https://testingcf.jsdelivr.net/npm/jquery-ui/+esm';import{getPresetNames as t}from'https://testingcf.jsdelivr.net/npm/@types/function/preset/+esm';var n={};n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const o=$;var a=n.n(o);const l=_;var r=n.n(l);const c=toastr;var s=n.n(c);const i=Vue;function d(e){return!!(0,i.getCurrentScope)()&&((0,i.onScopeDispose)(e),!0)}const m=new WeakMap,u=(...e)=>{var t;const n=e[0],o=null==(t=(0,i.getCurrentInstance)())?void 0:t.proxy;if(null==o&&!(0,i.hasInjectionContext)())throw new Error('injectLocal must be called in setup');return o&&m.has(o)&&n in m.get(o)?m.get(o)[n]:(0,i.inject)(...e)};const p='undefined'!=typeof window&&'undefined'!=typeof document,f=('undefined'!=typeof WorkerGlobalScope&&(globalThis,WorkerGlobalScope),Object.prototype.toString),v=e=>'[object Object]'===f.call(e);function h(e){return e.endsWith('rem')?16*Number.parseFloat(e):Number.parseFloat(e)}function b(e){return Array.isArray(e)?e:[e]}function g(e){const t=Object.create(null);return n=>t[n]||(t[n]=e(n))}const x=/\B([A-Z])/g,y=(g(e=>e.replace(x,'-$1').toLowerCase()),/-(\w)/g);g(e=>e.replace(y,(_,e)=>e?e.toUpperCase():''));function N(e){return e||(0,i.getCurrentInstance)()}const E=p?window:void 0;p&&window.document,p&&window.navigator,p&&window.location;function V(e){var t;const n=(0,i.toValue)(e);return null!=(t=null==n?void 0:n.$el)?t:n}function w(...e){const t=[],n=()=>{t.forEach(e=>e()),t.length=0},o=(0,i.computed)(()=>{const t=b((0,i.toValue)(e[0])).filter(e=>null!=e);return t.every(e=>'string'!=typeof e)?t:void 0}),a=(l=()=>{var t,n;return[null!=(n=null==(t=o.value)?void 0:t.map(e=>V(e)))?n:[E].filter(e=>null!=e),b((0,i.toValue)(o.value?e[1]:e[0])),b((0,i.unref)(o.value?e[2]:e[1])),(0,i.toValue)(o.value?e[3]:e[2])]},r=([e,o,a,l])=>{if(n(),!(null==e?void 0:e.length)||!(null==o?void 0:o.length)||!(null==a?void 0:a.length))return;const r=v(l)?{...l}:l;t.push(...e.flatMap(e=>o.flatMap(t=>a.map(n=>((e,t,n,o)=>(e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)))(e,t,n,r)))))},c={flush:'post'},(0,i.watch)(l,r,{...c,immediate:!0}));var l,r,c;return d(n),()=>{a(),n()}}function k(e){const t=function(){const e=(0,i.shallowRef)(!1),t=(0,i.getCurrentInstance)();return t&&(0,i.onMounted)(()=>{e.value=!0},t),e}();return(0,i.computed)(()=>(t.value,Boolean(e())))}const B=Symbol('vueuse-ssr-width');function C(){const e=(0,i.hasInjectionContext)()?u(B,null):null;return'number'==typeof e?e:void 0}function M(e,t={}){const{window:n=E,ssrWidth:o=C()}=t,a=k(()=>n&&'matchMedia'in n&&'function'==typeof n.matchMedia),l=(0,i.shallowRef)('number'==typeof o),r=(0,i.shallowRef)(),c=(0,i.shallowRef)(!1);return(0,i.watchEffect)(()=>{if(l.value){l.value=!a.value;const t=(0,i.toValue)(e).split(',');return void(c.value=t.some(e=>{const t=e.includes('not all'),n=e.match(/\(\s*min-width:\s*(-?\d+(?:\.\d*)?[a-z]+\s*)\)/),a=e.match(/\(\s*max-width:\s*(-?\d+(?:\.\d*)?[a-z]+\s*)\)/);let l=Boolean(n||a);return n&&l&&(l=o>=h(n[1])),a&&l&&(l=o<=h(a[1])),t?!l:l}))}a.value&&(r.value=n.matchMedia((0,i.toValue)(e)),c.value=r.value.matches)}),w(r,'change',e=>{c.value=e.matches},{passive:!0}),(0,i.computed)(()=>c.value)}function S(e,t={}){function n(t,n){let o=(0,i.toValue)(e[(0,i.toValue)(t)]);return null!=n&&(o=function(e,t){var n;if('number'==typeof e)return e+t;const o=(null==(n=e.match(/^-?\d+\.?\d*/))?void 0:n[0])||'',a=e.slice(o.length),l=Number.parseFloat(o)+t;return Number.isNaN(l)?e:l+a}(o,n)),'number'==typeof o&&(o=`${o}px`),o}const{window:o=E,strategy:a='min-width',ssrWidth:l=C()}=t,r='number'==typeof l,c=r?(0,i.shallowRef)(!1):{value:!0};function s(e,t){return!c.value&&r?'min'===e?l>=h(t):l<=h(t):!!o&&o.matchMedia(`(${e}-width: ${t})`).matches}r&&function(e,t=!0,n){N(n)?(0,i.onMounted)(e,n):t?e():(0,i.nextTick)(e)}(()=>c.value=!!o);const d=e=>M(()=>`(min-width: ${n(e)})`,t),m=e=>M(()=>`(max-width: ${n(e)})`,t),u=Object.keys(e).reduce((e,t)=>(Object.defineProperty(e,t,{get:()=>'min-width'===a?d(t):m(t),enumerable:!0,configurable:!0}),e),{});function p(){const t=Object.keys(e).map(e=>[e,u[e],h(n(e))]).sort((e,t)=>e[2]-t[2]);return(0,i.computed)(()=>t.filter(([,e])=>e.value).map(([e])=>e))}return Object.assign(u,{greaterOrEqual:d,smallerOrEqual:m,greater:e=>M(()=>`(min-width: ${n(e,.1)})`,t),smaller:e=>M(()=>`(max-width: ${n(e,-.1)})`,t),between:(e,o)=>M(()=>`(min-width: ${n(e)}) and (max-width: ${n(o,-.1)})`,t),isGreater:e=>s('min',n(e,.1)),isGreaterOrEqual:e=>s('min',n(e)),isSmaller:e=>s('max',n(e,-.1)),isSmallerOrEqual:e=>s('max',n(e)),isInBetween:(e,t)=>s('min',n(e))&&s('max',n(t,-.1)),current:p,active(){const e=p();return(0,i.computed)(()=>0===e.value.length?'':e.value.at('min-width'===a?-1:0))}})}'undefined'!=typeof globalThis?globalThis:'undefined'!=typeof window?window:'undefined'!=typeof globalThis?globalThis:'undefined'!=typeof self&&self;Number.POSITIVE_INFINITY;const j={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},D={class:'flex items-center justify-between border-b p-4 bg-gray-50'},P={class:'flex-1 overflow-y-auto p-6'},O={class:'text-center space-y-2'},A={class:'text-gray-600'},T={class:'font-semibold text-gray-900'},I={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},L=(0,i.defineComponent)({__name:'DeleteBranchModal',props:{branchName:{}},emits:['close','delete'],setup(e,{emit:t}){const n=t,o=S({mobile:640}).smaller('mobile');function a(){n('delete')}return(t,n)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',j,[(0,i.createElementVNode)('div',{class:(0,i.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,i.unref)(o)}])},[(0,i.createCommentVNode)(' 标题栏 '),(0,i.createElementVNode)('div',D,[n[3]||(n[3]=(0,i.createElementVNode)('h2',{class:'text-lg font-semibold'},'删除分支',-1)),(0,i.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[2]||(n[2]=[(0,i.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,i.createCommentVNode)(' 内容区 '),(0,i.createElementVNode)('div',P,[(0,i.createCommentVNode)(' 警告图标 '),n[7]||(n[7]=(0,i.createElementVNode)('div',{class:'flex justify-center mb-4'},[(0,i.createElementVNode)('div',{class:'w-16 h-16 rounded-full bg-red-100 flex items-center justify-center'},[(0,i.createElementVNode)('i',{class:'fas fa-exclamation-triangle text-3xl text-red-500'})])],-1)),(0,i.createCommentVNode)(' 警告文字 '),(0,i.createElementVNode)('div',O,[n[6]||(n[6]=(0,i.createElementVNode)('h3',{class:'text-lg font-semibold text-gray-900'},'确定要删除此分支吗？',-1)),(0,i.createElementVNode)('p',A,[n[4]||(n[4]=(0,i.createTextVNode)(' 分支 ',-1)),(0,i.createElementVNode)('span',T,'"'+(0,i.toDisplayString)(e.branchName)+'"',1),n[5]||(n[5]=(0,i.createTextVNode)(' 将被永久删除，此操作无法撤销。 ',-1))])])]),(0,i.createCommentVNode)(' 底部按钮 '),(0,i.createElementVNode)('div',I,[(0,i.createElementVNode)('button',{onClick:n[1]||(n[1]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,i.createElementVNode)('button',{onClick:a,class:'px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 active:bg-red-700 transition-colors touch-manipulation min-h-[44px]'},' 删除 ')])],2)]))}}),F={class:'fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4'},R={class:'flex items-center justify-between border-b p-4 bg-gray-50'},W={class:'flex-1 overflow-y-auto p-4'},U={class:'mb-4'},q={class:'font-medium'},G={class:'space-y-2'},J={class:'flex-1 min-w-0 pr-3'},H={class:'text-sm font-medium truncate'},Y={key:0,class:'text-xs text-gray-500 truncate mt-1'},Z=['onUpdate:modelValue'],K={key:0,class:'p-8 text-center text-gray-500 text-sm'},Q={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},X=(0,i.defineComponent)({__name:'EditPromptsModal',props:{presetName:{},prompts:{}},emits:['close','saveAsNewBranch'],setup(e,{emit:t}){const n=e,o=t,a=S({mobile:640}).smaller('mobile');function l(){const e={};n.prompts.forEach(t=>{t.id&&(e[t.id]=t.enabled)}),o('saveAsNewBranch',e)}return(t,n)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',F,[(0,i.createElementVNode)('div',{class:(0,i.normalizeClass)(['w-full max-w-2xl bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,i.unref)(a)}])},[(0,i.createCommentVNode)(' 标题栏 '),(0,i.createElementVNode)('div',R,[n[3]||(n[3]=(0,i.createElementVNode)('h2',{class:'text-lg font-semibold'},'修改预设条目',-1)),(0,i.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[2]||(n[2]=[(0,i.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,i.createCommentVNode)(' 内容区 '),(0,i.createElementVNode)('div',W,[(0,i.createElementVNode)('div',U,[n[4]||(n[4]=(0,i.createElementVNode)('span',{class:'text-sm text-gray-600'},'当前预设：',-1)),(0,i.createElementVNode)('span',q,(0,i.toDisplayString)(e.presetName),1)]),(0,i.createElementVNode)('div',G,[((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(e.prompts,e=>((0,i.openBlock)(),(0,i.createElementBlock)('div',{key:e.id,class:(0,i.normalizeClass)(['flex items-center justify-between p-3 border rounded-lg transition-colors',{'bg-blue-50 border-blue-300':e.enabled,'hover:bg-gray-50':!e.enabled}])},[(0,i.createElementVNode)('div',J,[(0,i.createElementVNode)('div',H,(0,i.toDisplayString)(e.name),1),e.content?((0,i.openBlock)(),(0,i.createElementBlock)('div',Y,(0,i.toDisplayString)(e.content),1)):(0,i.createCommentVNode)('v-if',!0)]),(0,i.withDirectives)((0,i.createElementVNode)('input',{type:'checkbox','onUpdate:modelValue':t=>e.enabled=t,class:'w-5 h-5 rounded border-gray-300 text-blue-500 focus:ring-blue-500 touch-manipulation cursor-pointer'},null,8,Z),[[i.vModelCheckbox,e.enabled]])],2))),128)),e.prompts.length?(0,i.createCommentVNode)('v-if',!0):((0,i.openBlock)(),(0,i.createElementBlock)('div',K,' 暂无提示词条目 '))])]),(0,i.createCommentVNode)(' 底部按钮 '),(0,i.createElementVNode)('div',Q,[(0,i.createElementVNode)('button',{onClick:n[1]||(n[1]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,i.createElementVNode)('button',{onClick:l,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 transition-colors touch-manipulation min-h-[44px]'},' 保存为新分支 ')])],2)]))}}),ee='preset_branches';function te(){return getVariables({type:'script',script_id:getScriptId()})[ee]||{}}function ne(e){replaceVariables({...getVariables({type:'script',script_id:getScriptId()}),[ee]:e},{type:'script',script_id:getScriptId()})}function oe(e){return te()[e]||null}function ae(e){const t=oe(e);return t&&t.branches?Object.entries(t.branches).map(([e,n])=>({name:e,description:n.description,createdAt:n.createdAt,updatedAt:n.updatedAt,isActive:e===t.activeBranch})):[]}function le(e){const t=oe(e);return t?.activeBranch||null}function re(){try{const e=getPreset('in_use');return e&&e.prompts?e.prompts.map(e=>({id:e.id||'',name:e.name||'未命名提示词',enabled:e.enabled||!1,content:e.content||''})):[]}catch(e){return console.error('获取预设提示词失败:',e),[]}}const ce={key:0,class:'fixed bottom-4 right-4 z-50'},se={class:'fixed inset-0 z-50 bg-white flex flex-col'},ie={class:'flex-1 p-4 space-y-4 overflow-y-auto'},de=['value'],me={class:'flex gap-2'},ue={key:0,value:''},pe=['value'],fe={key:0,class:'border rounded-lg divide-y max-h-64 overflow-y-auto'},ve=['onClick'],he={class:'flex items-center justify-between'},be={class:'flex-1 min-w-0'},ge={class:'text-sm font-medium truncate'},xe={key:0,class:'text-xs text-gray-500 truncate mt-1'},ye={key:0,class:'fas fa-check text-blue-500 ml-2'},Ne={class:'flex flex-col gap-2 pt-2'},Ee={key:0,class:'flex gap-2'},Ve={id:'preset-branch-float',class:'fixed z-50 w-80 bg-white rounded-lg shadow-xl border border-gray-200',style:{left:'50%',top:'50%',transform:'translate(-50%, -50%)'}},we={class:'flex items-center gap-2 p-3 border-b'},ke=['value'],Be={key:0,value:''},Ce=['value'],Me={key:0,class:'flex gap-1'},Se={class:'max-h-64 overflow-y-auto'},je={key:0,class:'p-4 text-center text-gray-500 text-sm'},De={key:1,class:'divide-y'},Pe=['onClick'],_e={class:'flex items-center justify-between'},Oe={class:'flex-1 min-w-0'},Ae={class:'text-sm font-medium truncate'},$e={key:0,class:'text-xs text-gray-500 truncate mt-1'},Te={key:0,class:'fas fa-check text-blue-500'},ze=(0,i.defineComponent)({__name:'FloatingWindow',emits:['edit','rename','delete'],setup(e,{expose:n,emit:o}){const l=o,r=S({mobile:640}).smaller('mobile'),c=(0,i.ref)(!0),d=(0,i.ref)(null),m=(0,i.ref)([]),u=(0,i.ref)(''),p=(0,i.ref)([]),f=(0,i.ref)('');async function v(){try{const e=function(){try{return getLoadedPresetName()}catch(e){return console.error('获取当前预设名称失败:',e),''}}();e&&(u.value=e,await h(u.value),f.value=le(u.value)||'')}catch(e){console.error('加载当前预设失败:',e)}}async function h(e){try{p.value=ae(e)}catch(e){console.error('加载分支列表失败:',e),p.value=[]}}async function b(){try{await h(u.value),f.value=le(u.value)||''}catch(e){console.error('切换预设失败:',e),s().error('切换预设失败')}}async function g(){if(f.value)try{(function(e,t){const n=te(),o=n[e];if(!o||!o.branches[t])return!1;const a=o.branches[t];try{const e=getPreset('in_use');return e&&e.prompts?(e.prompts.forEach(e=>{e.id&&a.promptsEnabled.hasOwnProperty(e.id)&&(e.enabled=a.promptsEnabled[e.id])}),replacePreset('in_use',e),o.activeBranch=t,ne(n),!0):(console.error('无法获取当前预设'),!1)}catch(e){return console.error('切换分支失败:',e),!1}})(u.value,f.value)?(await h(u.value),s().success('切换分支成功')):s().error('切换分支失败')}catch(e){console.error('切换分支失败:',e),s().error('切换分支失败')}}async function x(e){f.value=e,await g()}function y(){c.value=!c.value}function N(){l('edit')}function E(){f.value&&l('rename',f.value)}function V(){f.value&&l('delete',f.value)}return(0,i.onMounted)(async()=>{await async function(){try{const e=await async function(){try{return t()||[]}catch(e){return console.error('获取预设列表失败:',e),[]}}();m.value=e}catch(e){console.error('加载预设列表失败:',e),s().error('加载预设列表失败')}}(),await v(),r.value||(await(0,i.nextTick)(),function(){if(!d.value)return;const e=a()('#preset-branch-float');e.draggable({handle:d.value,containment:'window',stop:(e,t)=>{localStorage.setItem('preset-branch-position',JSON.stringify({left:t.position.left,top:t.position.top}))}});const t=localStorage.getItem('preset-branch-position');if(t)try{const{left:n,top:o}=JSON.parse(t);e.css({left:n,top:o})}catch(e){console.error('恢复悬浮窗位置失败:',e)}}())}),n({refreshPreset:v,refreshBranches:async()=>{u.value&&await h(u.value)}}),(e,t)=>((0,i.openBlock)(),(0,i.createElementBlock)(i.Fragment,null,[(0,i.createCommentVNode)(' 移动端：底部浮动按钮 '),(0,i.unref)(r)?((0,i.openBlock)(),(0,i.createElementBlock)('div',ce,[c.value?((0,i.openBlock)(),(0,i.createElementBlock)(i.Fragment,{key:1},[(0,i.createCommentVNode)(' 移动端全屏展开 '),(0,i.createElementVNode)('div',se,[(0,i.createElementVNode)('div',{class:'flex items-center justify-between border-b p-4 bg-white'},[t[6]||(t[6]=(0,i.createElementVNode)('h2',{class:'text-lg font-semibold'},'预设分支管理',-1)),(0,i.createElementVNode)('button',{onClick:y,class:'p-2 touch-manipulation'},[...t[5]||(t[5]=[(0,i.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,i.createElementVNode)('div',ie,[(0,i.createCommentVNode)(' 预设选择 '),(0,i.createElementVNode)('div',null,[t[7]||(t[7]=(0,i.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'选择预设',-1)),(0,i.withDirectives)((0,i.createElementVNode)('select',{'onUpdate:modelValue':t[0]||(t[0]=e=>u.value=e),onChange:b,class:'w-full min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation bg-white'},[((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(m.value,e=>((0,i.openBlock)(),(0,i.createElementBlock)('option',{key:e,value:e},(0,i.toDisplayString)(e),9,de))),128))],544),[[i.vModelSelect,u.value]])]),(0,i.createCommentVNode)(' 分支选择 '),(0,i.createElementVNode)('div',null,[t[8]||(t[8]=(0,i.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'选择分支',-1)),(0,i.createElementVNode)('div',me,[(0,i.withDirectives)((0,i.createElementVNode)('select',{'onUpdate:modelValue':t[1]||(t[1]=e=>f.value=e),onChange:g,class:'flex-1 min-h-[44px] rounded-lg border px-4 py-3 touch-manipulation bg-white'},[p.value.length?(0,i.createCommentVNode)('v-if',!0):((0,i.openBlock)(),(0,i.createElementBlock)('option',ue,'无分支')),((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(p.value,e=>((0,i.openBlock)(),(0,i.createElementBlock)('option',{key:e.name,value:e.name},(0,i.toDisplayString)(e.name),9,pe))),128))],544),[[i.vModelSelect,f.value]])])]),(0,i.createCommentVNode)(' 分支列表 '),p.value.length>0?((0,i.openBlock)(),(0,i.createElementBlock)('div',fe,[((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(p.value,e=>((0,i.openBlock)(),(0,i.createElementBlock)('div',{key:e.name,onClick:t=>x(e.name),class:(0,i.normalizeClass)(['p-3 cursor-pointer touch-manipulation',e.isActive?'bg-blue-50':'hover:bg-gray-50'])},[(0,i.createElementVNode)('div',he,[(0,i.createElementVNode)('div',be,[(0,i.createElementVNode)('div',ge,(0,i.toDisplayString)(e.name),1),e.description?((0,i.openBlock)(),(0,i.createElementBlock)('div',xe,(0,i.toDisplayString)(e.description),1)):(0,i.createCommentVNode)('v-if',!0)]),e.isActive?((0,i.openBlock)(),(0,i.createElementBlock)('i',ye)):(0,i.createCommentVNode)('v-if',!0)])],10,ve))),128))])):(0,i.createCommentVNode)('v-if',!0),(0,i.createCommentVNode)(' 操作按钮 '),(0,i.createElementVNode)('div',Ne,[(0,i.createElementVNode)('button',{onClick:N,class:'w-full min-h-[44px] rounded-lg bg-blue-500 px-4 py-3 text-white font-medium touch-manipulation active:bg-blue-600'},[...t[9]||(t[9]=[(0,i.createElementVNode)('i',{class:'fas fa-edit mr-2'},null,-1),(0,i.createTextVNode)('修改条目 ',-1)])]),f.value?((0,i.openBlock)(),(0,i.createElementBlock)('div',Ee,[(0,i.createElementVNode)('button',{onClick:E,class:'flex-1 min-h-[44px] rounded-lg bg-gray-200 px-4 py-3 font-medium touch-manipulation active:bg-gray-300'},[...t[10]||(t[10]=[(0,i.createElementVNode)('i',{class:'fas fa-edit mr-2'},null,-1),(0,i.createTextVNode)('重命名 ',-1)])]),(0,i.createElementVNode)('button',{onClick:V,class:'flex-1 min-h-[44px] rounded-lg bg-red-500 px-4 py-3 text-white font-medium touch-manipulation active:bg-red-600'},[...t[11]||(t[11]=[(0,i.createElementVNode)('i',{class:'fas fa-trash mr-2'},null,-1),(0,i.createTextVNode)('删除 ',-1)])])])):(0,i.createCommentVNode)('v-if',!0)])])])],2112)):((0,i.openBlock)(),(0,i.createElementBlock)('button',{key:0,onClick:y,class:'h-14 w-14 rounded-full bg-blue-500 shadow-lg touch-manipulation active:scale-95 flex items-center justify-center'},[...t[4]||(t[4]=[(0,i.createElementVNode)('i',{class:'fas fa-code-branch text-2xl text-white'},null,-1)])]))])):((0,i.openBlock)(),(0,i.createElementBlock)(i.Fragment,{key:1},[(0,i.createCommentVNode)(' 桌面端：悬浮窗 '),(0,i.createElementVNode)('div',Ve,[(0,i.createCommentVNode)(' 折叠状态 '),c.value?((0,i.openBlock)(),(0,i.createElementBlock)(i.Fragment,{key:1},[(0,i.createCommentVNode)(' 展开状态 '),(0,i.createElementVNode)('div',null,[(0,i.createCommentVNode)(' 顶部栏 '),(0,i.createElementVNode)('div',{class:'flex items-center justify-between p-3 border-b cursor-move bg-gray-50 rounded-t-lg',ref_key:'dragHandle',ref:d},[t[14]||(t[14]=(0,i.createElementVNode)('span',{class:'text-sm font-medium'},'预设分支',-1)),(0,i.createElementVNode)('button',{onClick:y,class:'text-gray-400 hover:text-gray-600'},[...t[13]||(t[13]=[(0,i.createElementVNode)('i',{class:'fas fa-chevron-up'},null,-1)])])],512),(0,i.createCommentVNode)(' 工具栏 '),(0,i.createElementVNode)('div',we,[(0,i.createElementVNode)('button',{onClick:N,class:'px-3 py-1.5 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors'},' 修改 '),(0,i.withDirectives)((0,i.createElementVNode)('select',{'onUpdate:modelValue':t[2]||(t[2]=e=>u.value=e),onChange:b,class:'flex-1 text-sm border rounded px-2 py-1.5 bg-white cursor-pointer'},[((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(m.value,e=>((0,i.openBlock)(),(0,i.createElementBlock)('option',{key:e,value:e},(0,i.toDisplayString)(e),9,ke))),128))],544),[[i.vModelSelect,u.value]]),(0,i.withDirectives)((0,i.createElementVNode)('select',{'onUpdate:modelValue':t[3]||(t[3]=e=>f.value=e),onChange:g,class:'flex-1 text-sm border rounded px-2 py-1.5 bg-white cursor-pointer'},[p.value.length?(0,i.createCommentVNode)('v-if',!0):((0,i.openBlock)(),(0,i.createElementBlock)('option',Be,'无分支')),((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(p.value,e=>((0,i.openBlock)(),(0,i.createElementBlock)('option',{key:e.name,value:e.name},(0,i.toDisplayString)(e.name),9,Ce))),128))],544),[[i.vModelSelect,f.value]]),f.value?((0,i.openBlock)(),(0,i.createElementBlock)('div',Me,[(0,i.createElementVNode)('button',{onClick:E,class:'p-1.5 text-gray-500 hover:text-gray-700 transition-colors',title:'重命名'},[...t[15]||(t[15]=[(0,i.createElementVNode)('i',{class:'fas fa-edit text-xs'},null,-1)])]),(0,i.createElementVNode)('button',{onClick:V,class:'p-1.5 text-red-500 hover:text-red-700 transition-colors',title:'删除'},[...t[16]||(t[16]=[(0,i.createElementVNode)('i',{class:'fas fa-trash text-xs'},null,-1)])])])):(0,i.createCommentVNode)('v-if',!0)]),(0,i.createCommentVNode)(' 分支列表 '),(0,i.createElementVNode)('div',Se,[p.value.length?((0,i.openBlock)(),(0,i.createElementBlock)('div',De,[((0,i.openBlock)(!0),(0,i.createElementBlock)(i.Fragment,null,(0,i.renderList)(p.value,e=>((0,i.openBlock)(),(0,i.createElementBlock)('div',{key:e.name,onClick:t=>x(e.name),class:(0,i.normalizeClass)(['p-3 cursor-pointer hover:bg-gray-50 transition-colors',e.isActive?'bg-blue-50 border-l-4 border-blue-500':''])},[(0,i.createElementVNode)('div',_e,[(0,i.createElementVNode)('div',Oe,[(0,i.createElementVNode)('div',Ae,(0,i.toDisplayString)(e.name),1),e.description?((0,i.openBlock)(),(0,i.createElementBlock)('div',$e,(0,i.toDisplayString)(e.description),1)):(0,i.createCommentVNode)('v-if',!0)]),e.isActive?((0,i.openBlock)(),(0,i.createElementBlock)('i',Te)):(0,i.createCommentVNode)('v-if',!0)])],10,Pe))),128))])):((0,i.openBlock)(),(0,i.createElementBlock)('div',je,' 暂无分支 '))])])],2112)):((0,i.openBlock)(),(0,i.createElementBlock)('div',{key:0,class:'flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50',onClick:y},[...t[12]||(t[12]=[(0,i.createElementVNode)('span',{class:'text-sm font-medium'},'预设分支',-1),(0,i.createElementVNode)('i',{class:'fas fa-chevron-down text-gray-400'},null,-1)])]))])],2112))],2112))}}),Ie={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},Le={class:'flex items-center justify-between border-b p-4 bg-gray-50'},Fe={class:'flex-1 overflow-y-auto p-4 space-y-4'},Re={class:'px-4 py-3 bg-gray-100 rounded-lg text-sm text-gray-600'},We=['placeholder'],Ue={key:0,class:'text-red-500 text-sm mt-1'},qe={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},Ge=['disabled'],Je=(0,i.defineComponent)({__name:'RenameBranchModal',props:{oldName:{},existingBranches:{}},emits:['close','rename'],setup(e,{emit:t}){const n=e,o=t,a=S({mobile:640}).smaller('mobile'),l=(0,i.ref)(n.oldName),r=(0,i.computed)(()=>l.value?l.value===n.oldName?'新名称与原名称相同':n.existingBranches.includes(l.value)?'分支名称已存在':'':'分支名称不能为空');function c(){r.value||o('rename',l.value)}return(t,n)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',Ie,[(0,i.createElementVNode)('div',{class:(0,i.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,i.unref)(a)}])},[(0,i.createCommentVNode)(' 标题栏 '),(0,i.createElementVNode)('div',Le,[n[4]||(n[4]=(0,i.createElementVNode)('h2',{class:'text-lg font-semibold'},'重命名分支',-1)),(0,i.createElementVNode)('button',{onClick:n[0]||(n[0]=e=>t.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...n[3]||(n[3]=[(0,i.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,i.createCommentVNode)(' 内容区 '),(0,i.createElementVNode)('div',Fe,[(0,i.createCommentVNode)(' 当前分支名称 '),(0,i.createElementVNode)('div',null,[n[5]||(n[5]=(0,i.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'当前分支名称',-1)),(0,i.createElementVNode)('div',Re,(0,i.toDisplayString)(e.oldName),1)]),(0,i.createCommentVNode)(' 新分支名称 '),(0,i.createElementVNode)('div',null,[n[6]||(n[6]=(0,i.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},[(0,i.createTextVNode)(' 新分支名称 '),(0,i.createElementVNode)('span',{class:'text-red-500'},'*')],-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':n[1]||(n[1]=e=>l.value=e),type:'text',placeholder:e.oldName,class:(0,i.normalizeClass)(['w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation',{'border-red-500':r.value}])},null,10,We),[[i.vModelText,l.value]]),r.value?((0,i.openBlock)(),(0,i.createElementBlock)('p',Ue,(0,i.toDisplayString)(r.value),1)):(0,i.createCommentVNode)('v-if',!0)])]),(0,i.createCommentVNode)(' 底部按钮 '),(0,i.createElementVNode)('div',qe,[(0,i.createElementVNode)('button',{onClick:n[2]||(n[2]=e=>t.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,i.createElementVNode)('button',{onClick:c,disabled:!l.value||!!r.value,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors touch-manipulation min-h-[44px]'},' 重命名 ',8,Ge)])],2)]))}}),He={class:'fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4'},Ye={class:'flex items-center justify-between border-b p-4 bg-gray-50'},Ze={class:'flex-1 overflow-y-auto p-4 space-y-4'},Ke={key:0,class:'text-red-500 text-sm mt-1'},Qe={class:'flex justify-end gap-3 border-t p-4 bg-gray-50'},Xe=['disabled'],et=(0,i.defineComponent)({__name:'SaveBranchModal',props:{existingBranches:{}},emits:['close','save'],setup(e,{emit:t}){const n=e,o=t,a=S({mobile:640}).smaller('mobile'),l=(0,i.ref)(''),r=(0,i.ref)(''),c=(0,i.computed)(()=>l.value?n.existingBranches.includes(l.value)?'分支名称已存在':'':'分支名称不能为空');function s(){c.value||o('save',l.value,r.value)}return(e,t)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',He,[(0,i.createElementVNode)('div',{class:(0,i.normalizeClass)(['w-full max-w-md bg-white rounded-lg shadow-xl overflow-hidden flex flex-col',{'h-full rounded-none':(0,i.unref)(a)}])},[(0,i.createCommentVNode)(' 标题栏 '),(0,i.createElementVNode)('div',Ye,[t[5]||(t[5]=(0,i.createElementVNode)('h2',{class:'text-lg font-semibold'},'保存为新分支',-1)),(0,i.createElementVNode)('button',{onClick:t[0]||(t[0]=t=>e.$emit('close')),class:'p-2 touch-manipulation hover:bg-gray-200 rounded-lg transition-colors'},[...t[4]||(t[4]=[(0,i.createElementVNode)('i',{class:'fas fa-times text-xl text-gray-600'},null,-1)])])]),(0,i.createCommentVNode)(' 内容区 '),(0,i.createElementVNode)('div',Ze,[(0,i.createCommentVNode)(' 分支名称 '),(0,i.createElementVNode)('div',null,[t[6]||(t[6]=(0,i.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},[(0,i.createTextVNode)(' 分支名称 '),(0,i.createElementVNode)('span',{class:'text-red-500'},'*')],-1)),(0,i.withDirectives)((0,i.createElementVNode)('input',{'onUpdate:modelValue':t[1]||(t[1]=e=>l.value=e),type:'text',placeholder:'输入分支名称',class:(0,i.normalizeClass)(['w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation',{'border-red-500':c.value}])},null,2),[[i.vModelText,l.value]]),c.value?((0,i.openBlock)(),(0,i.createElementBlock)('p',Ke,(0,i.toDisplayString)(c.value),1)):(0,i.createCommentVNode)('v-if',!0)]),(0,i.createCommentVNode)(' 分支描述 '),(0,i.createElementVNode)('div',null,[t[7]||(t[7]=(0,i.createElementVNode)('label',{class:'block text-sm font-medium mb-2'},'描述（可选）',-1)),(0,i.withDirectives)((0,i.createElementVNode)('textarea',{'onUpdate:modelValue':t[2]||(t[2]=e=>r.value=e),placeholder:'输入分支描述',rows:'3',class:'w-full min-h-[44px] rounded-lg border border-gray-300 px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 touch-manipulation resize-none'},null,512),[[i.vModelText,r.value]])])]),(0,i.createCommentVNode)(' 底部按钮 '),(0,i.createElementVNode)('div',Qe,[(0,i.createElementVNode)('button',{onClick:t[3]||(t[3]=t=>e.$emit('close')),class:'px-6 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-colors touch-manipulation min-h-[44px]'},' 取消 '),(0,i.createElementVNode)('button',{onClick:s,disabled:!l.value||!!c.value,class:'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors touch-manipulation min-h-[44px]'},' 保存 ',8,Xe)])],2)]))}});async function tt(){if(console.info('[预设分支管理] 脚本初始化开始'),'undefined'==typeof getPreset||'undefined'==typeof replacePreset)return console.error('[预设分支管理] 预设接口不可用'),void s().error('预设分支管理：预设接口不可用');const t=(0,i.createApp)({components:{FloatingWindow:ze,EditPromptsModal:X,SaveBranchModal:et,RenameBranchModal:Je,DeleteBranchModal:L},setup(){const e=(0,i.ref)(!1),t=(0,i.ref)(!1),n=(0,i.ref)(!1),o=(0,i.ref)(!1),a=(0,i.ref)([]),l=(0,i.ref)(''),c=(0,i.ref)(''),d=(0,i.ref)(''),m=(0,i.ref)(''),u=(0,i.ref)(''),p=(0,i.ref)(''),f=(0,i.ref)(null);eventOn(tavern_events.PRESET_CHANGED,async()=>{console.info('[预设分支管理] 预设已变更，刷新界面'),f.value&&await f.value.refreshPreset()});const v=r().debounce(()=>{try{const e=getLoadedPresetName();if(e&&le(e)){!function(e,t){const n=te(),o=n[e];if(!o||!o.activeBranch)return;const a=o.activeBranch;o.branches[a]&&(o.branches[a].promptsEnabled={...t},o.branches[a].updatedAt=Date.now(),ne(n))}(e,function(){const e=re(),t={};return e.forEach(e=>{e.id&&(t[e.id]=e.enabled)}),t}())}}catch(e){console.error('[预设分支管理] 更新激活分支失败:',e)}},1e3);let h=null;return setInterval(()=>{try{const e=getPreset('in_use'),t=JSON.stringify(e.prompts?.map(e=>({id:e.id,enabled:e.enabled})));h&&h!==t&&(console.info('[预设分支管理] 检测到预设变更'),v()),h=t}catch(e){}},2e3),{showEditModal:e,showSaveModal:t,showRenameModal:n,showDeleteModal:o,editPrompts:a,editPresetName:l,saveBranchName:c,saveBranchDescription:d,renameOldName:m,renameNewName:u,deleteBranchName:p,floatingWindowRef:f,openEditModal:function(){try{l.value=getLoadedPresetName()||'未知预设',a.value=re(),e.value=!0}catch(e){console.error('[预设分支管理] 打开编辑弹窗失败:',e),s().error('打开编辑弹窗失败')}},openSaveBranchModal:function(e){a.value.forEach(t=>{t.id&&e.hasOwnProperty(t.id)&&(t.enabled=e[t.id])});const n=getLoadedPresetName();if(n){ae(n).map(e=>e.name);t.value=!0}},saveNewBranch:function(e,n){try{const o={};a.value.forEach(e=>{e.id&&(o[e.id]=e.enabled)});const l=getLoadedPresetName();if(!l)return void s().error('无法获取当前预设名称');const r=function(e,t,n,o){const a=te();a[e]||(a[e]={activeBranch:null,branches:{}});const l=a[e];if(l.branches[t])return!1;const r=Date.now(),c={promptsEnabled:{...n},createdAt:r,updatedAt:r,description:o};return l.branches[t]=c,l.activeBranch=t,ne(a),!0}(l,e,o,n);r?(t.value=!1,c.value='',d.value='',f.value&&f.value.refreshBranches(),s().success(`分支 "${e}" 创建成功`)):s().error('分支创建失败，可能名称已存在')}catch(e){console.error('[预设分支管理] 保存分支失败:',e),s().error('保存分支失败')}},openRenameModal:function(e){m.value=e,u.value=e,n.value=!0},renameBranchAction:function(e){try{const t=getLoadedPresetName();if(!t)return void s().error('无法获取当前预设名称');(function(e,t,n){const o=te(),a=o[e];return!(!a||!a.branches[t]||a.branches[n]||(a.branches[n]={...a.branches[t],updatedAt:Date.now()},a.activeBranch===t&&(a.activeBranch=n),delete a.branches[t],ne(o),0))})(t,m.value,e)?(n.value=!1,m.value='',u.value='',f.value&&f.value.refreshBranches(),s().success('分支重命名成功')):s().error('分支重命名失败，可能名称已存在')}catch(e){console.error('[预设分支管理] 重命名分支失败:',e),s().error('重命名分支失败')}},openDeleteModal:function(e){p.value=e,o.value=!0},deleteBranchAction:function(){try{const e=getLoadedPresetName();if(!e)return void s().error('无法获取当前预设名称');(function(e,t){const n=te(),o=n[e];if(!o||!o.branches[t])return!1;if(o.activeBranch===t){const e=Object.keys(o.branches).filter(e=>e!==t);o.activeBranch=e.length>0?e[0]:null}return delete o.branches[t],0===Object.keys(o.branches).length&&delete n[e],ne(n),!0})(e,p.value)?(o.value=!1,p.value='',f.value&&f.value.refreshBranches(),s().success('分支删除成功')):s().error('分支删除失败')}catch(e){console.error('[预设分支管理] 删除分支失败:',e),s().error('删除分支失败')}},getExistingBranchNames:()=>{const e=getLoadedPresetName();return e?ae(e).map(e=>e.name):[]}}},template:'\n      <div>\n        <FloatingWindow ref="floatingWindowRef" @edit="openEditModal" @rename="openRenameModal" @delete="openDeleteModal" />\n        <EditPromptsModal v-if="showEditModal" :preset-name="editPresetName" :prompts="editPrompts" @close="showEditModal = false" @saveAsNewBranch="openSaveBranchModal" />\n        <SaveBranchModal v-if="showSaveModal" :existing-branches="getExistingBranchNames()" @close="showSaveModal = false" @save="saveNewBranch" />\n        <RenameBranchModal v-if="showRenameModal" :old-name="renameOldName" :existing-branches="getExistingBranchNames()" @close="showRenameModal = false" @rename="renameBranchAction" />\n        <DeleteBranchModal v-if="showDeleteModal" :branch-name="deleteBranchName" @close="showDeleteModal = false" @delete="deleteBranchAction" />\n      </div>\n    '}),n=e();t.use(n);const{destroy:o}=function(e='head'){const t=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo(e);return{destroy:()=>t.remove()}}(),l=$('<div>').attr('script_id',getScriptId()).appendTo('body');t.mount(l[0]),console.info('[预设分支管理] 脚本初始化完成'),s().success('预设分支管理已加载'),a()(window).on('pagehide',()=>{t.unmount(),l.remove(),o(),console.info('[预设分支管理] 脚本已卸载')})}a()(()=>{errorCatched(tt)()});
//# sourceMappingURL=index.js.map